<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام محاسبة - بقالة أبو مالك للمواد الغذائية والبهارات</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* جميع الأنماط السابقة تبقى كما هي */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', 'Cairo', sans-serif;
        }
        
        :root {
            --primary: #2c5f2d;
            --secondary: #97bc62;
            --accent: #fccb06;
            --profit: #27ae60;
            --loss: #e74c3c;
            --light: #f8f9fa;
            --dark: #343a40;
            --danger: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --info: #3498db;
            --purple: #9b59b6;
            --border-radius: 10px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
            padding-bottom: 120px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* شاشة تسجيل الدخول */
        #login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        
        .login-box {
            background-color: white;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .login-box h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .login-box p {
            color: #666;
            margin-bottom: 30px;
        }
        
        /* ترويسة */
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.5rem;
            color: var(--accent);
        }
        
        .logo-text h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .logo-text p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .date-display {
            background-color: rgba(255, 255, 255, 0.15);
            padding: 8px 15px;
            border-radius: var(--border-radius);
            font-weight: 600;
            text-align: center;
        }
        
        /* شريط الربح المباشر */
        .profit-display {
            background-color: var(--profit);
            color: white;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: pulse 2s infinite;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .profit-display.loss {
            background-color: var(--loss);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        /* شريط التنقل */
        .nav-tabs {
            display: flex;
            background-color: white;
            border-bottom: 2px solid var(--secondary);
            overflow-x: auto;
            margin-top: 20px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }
        
        .tab {
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            position: relative;
            flex: 1;
            text-align: center;
            min-width: 120px;
        }
        
        .tab:hover {
            background-color: #f8f9fa;
            color: var(--primary);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background-color: rgba(44, 95, 45, 0.05);
        }
        
        .tab.locked::after {
            content: '\f023';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            color: var(--warning);
        }
        
        .tab i {
            margin-left: 8px;
        }
        
        /* محتوى التبويبات */
        .tab-content {
            display: none;
            background-color: white;
            padding: 25px;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.locked {
            display: none !important;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* تحسينات الأزرار والنماذج */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #235824;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #25a25a;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background-color: var(--info);
            color: white;
        }
        
        .btn-info:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-purple {
            background-color: var(--purple);
            color: white;
        }
        
        .btn-purple:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
        }
        
        /* تحسين النماذج */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border 0.3s;
            background-color: #f9f9f9;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background-color: white;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        /* تحسين الجداول */
        .table-container {
            overflow-x: auto;
            margin-top: 25px;
            border-radius: var(--border-radius);
            border: 1px solid #eee;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 700;
            color: var(--primary);
            border-bottom: 2px solid var(--secondary);
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* تحسين الإحصائيات */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #fff, #f8f9fa);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            border-top: 5px solid var(--primary);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .stat-card .value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        .stat-card .subtext {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* تحسين التنبيهات */
        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .alert-info {
            background-color: #e1f5fe;
            border-right: 5px solid var(--info);
            color: #0c5460;
        }
        
        .alert-success {
            background-color: #d4edda;
            border-right: 5px solid var(--success);
            color: #155724;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            border-right: 5px solid var(--warning);
            color: #856404;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            border-right: 5px solid var(--danger);
            color: #721c24;
        }
        
        /* تحسين المودال */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        /* إشعارات */
        #notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 600;
            z-index: 3000;
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }
        
        #notification.show {
            transform: translateX(0);
        }
        
        #notification.success {
            background-color: var(--success);
        }
        
        #notification.danger {
            background-color: var(--danger);
        }
        
        #notification.warning {
            background-color: var(--warning);
        }
        
        #notification.info {
            background-color: var(--info);
        }
        
        /* تذييل الصفحة */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 0;
            text-align: center;
            z-index: 100;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        .footer h3 {
            font-size: 1.2rem;
            margin-bottom: 5px;
            color: var(--accent);
        }
        
        .footer p {
            font-size: 1rem;
            margin-bottom: 5px;
            opacity: 0.9;
        }
        
        .footer .copyright {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* شريط الأدوات السفلي */
        .toolbar {
            position: fixed;
            bottom: 80px;
            right: 0;
            left: 0;
            background-color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 99;
        }
        
        .toolbar .btn {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        /* الأصناف السريعة */
        .quick-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .category-chip {
            padding: 8px 15px;
            background-color: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .category-chip:hover {
            background-color: #e0e0e0;
        }
        
        .category-chip.active {
            background-color: var(--primary);
            color: white;
        }
        
        /* شريط البحث */
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-bar input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
        }
        
        /* اقتراحات المنتجات */
        .quick-product-select {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            margin-top: 5px;
        }
        
        .product-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s;
        }
        
        .product-item:hover {
            background-color: #f5f5f5;
        }
        
        .product-name {
            font-weight: 600;
            color: var(--primary);
        }
        
        .product-details {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.9rem;
            color: #666;
        }
        
        /* مؤشر الربح */
        .profit-indicator {
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .profit-positive {
            color: var(--success);
            background-color: rgba(39, 174, 96, 0.1);
        }
        
        .profit-negative {
            color: var(--danger);
            background-color: rgba(231, 76, 60, 0.1);
        }
        
        /* تحسين إجراءات الجدول */
        .table-actions {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        /* طباعة */
        @media print {
            .toolbar, .footer, .nav-tabs, .btn {
                display: none !important;
            }
            
            .tab-content {
                display: block !important;
                box-shadow: none;
            }
            
            .container {
                max-width: 100%;
            }
        }
        
        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header-right {
                flex-direction: column;
                width: 100%;
            }
            
            .profit-display, .date-display {
                width: 100%;
                justify-content: center;
            }
            
            .nav-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .toolbar {
                flex-wrap: wrap;
                bottom: 100px;
            }
        }
    </style>
</head>
<body>
    <!-- شاشة تسجيل الدخول -->
    <div id="login-screen">
        <div class="login-box">
            <div class="logo">
                <i class="fas fa-store-alt"></i>
                <div class="logo-text">
                    <h1>بقالة أبو مالك</h1>
                    <p>نظام المحاسبة المبسط</p>
                </div>
            </div>
            <p style="margin-top: 20px;">أدخل كلمة المرور للوصول للنظام</p>
            <div class="form-group">
                <input type="password" id="login-password" class="form-control" placeholder="كلمة المرور">
                <small style="display: block; margin-top: 5px; color: #666;">عمليات البيع متاحة بدون كلمة مرور</small>
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="login()">
                    <i class="fas fa-sign-in-alt"></i> دخول للنظام
                </button>
                <button class="btn btn-success" onclick="enterSalesOnly()">
                    <i class="fas fa-shopping-cart"></i> الدخول للمبيعات فقط
                </button>
            </div>
            <div style="margin-top: 20px; text-align: left; font-size: 0.9rem; color: #666;">
                <p><strong>ملاحظة:</strong></p>
                <p>- عمليات البيع متاحة للجميع بدون كلمة مرور</p>
                <p>- بقية الأقسام تحتاج كلمة مرور للوصول</p>
                <p>- كلمة المرور الافتراضية: <strong>123456</strong></p>
            </div>
        </div>
    </div>

    <!-- النظام الرئيسي (مخفي في البداية) -->
    <div id="main-system" style="display: none;">
        <!-- الترويسة -->
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <i class="fas fa-store-alt"></i>
                        <div class="logo-text">
                            <h1>بقالة أبو مالك للمواد الغذائية والبهارات</h1>
                            <p>نظام المحاسبة المبسط - العملة: الريال اليمني</p>
                        </div>
                    </div>
                    <div class="header-right">
                        <div class="profit-display" id="live-profit-display">
                            <i class="fas fa-chart-line"></i>
                            <span>الربح الحالي: <span id="current-profit">0 ريال</span></span>
                            <button class="btn btn-sm" onclick="toggleProfitDetails()" style="background: rgba(255,255,255,0.2); padding: 2px 8px; margin-right: 10px;">
                                <i class="fas fa-info"></i>
                            </button>
                        </div>
                        <div class="date-display" id="current-date-time">
                            <!-- سيتم ملؤه بالتاريخ والوقت عبر الجافاسكريبت -->
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- شريط التنقل -->
        <div class="container">
            <div class="nav-tabs">
                <div class="tab active" data-tab="sales">
                    <i class="fas fa-shopping-cart"></i> المبيعات
                </div>
                <div class="tab locked" data-tab="purchases">
                    <i class="fas fa-boxes"></i> المشتريات
                </div>
                <div class="tab locked" data-tab="expenses">
                    <i class="fas fa-money-bill-wave"></i> المصروفات
                </div>
                <div class="tab locked" data-tab="products">
                    <i class="fas fa-list"></i> إدارة الأصناف
                </div>
                <div class="tab locked" data-tab="summary">
                    <i class="fas fa-chart-bar"></i> التقارير
                </div>
                <div class="tab locked" data-tab="backup">
                    <i class="fas fa-database"></i> النسخ الاحتياطي
                </div>
                <div class="tab locked" data-tab="security">
                    <i class="fas fa-lock"></i> الأمان
                </div>
            </div>
            
            <!-- تبويب المبيعات اليومية -->
            <div id="sales" class="tab-content active">
                <h2 class="section-title">
                    <i class="fas fa-shopping-cart"></i> المبيعات اليومية
                </h2>
                
                <div class="stats-cards">
                    <div class="stat-card">
                        <h3>المبيعات اليوم</h3>
                        <div class="value" id="today-sales">0 ريال</div>
                        <div class="subtext">إجمالي مبيعات اليوم</div>
                    </div>
                    <div class="stat-card">
                        <h3>الربح اليوم</h3>
                        <div class="value" id="today-profit">0 ريال</div>
                        <div class="subtext">صافي ربح اليوم</div>
                    </div>
                    <div class="stat-card">
                        <h3>عدد العمليات</h3>
                        <div class="value" id="today-transactions">0</div>
                        <div class="subtext">عملية بيع اليوم</div>
                    </div>
                </div>
                
                <!-- الأصناف السريعة -->
                <div class="quick-categories" id="sales-categories">
                    <div class="category-chip active" data-category="all">جميع الأصناف</div>
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </div>
                
                <div class="search-bar">
                    <input type="text" id="search-sales" placeholder="ابحث في المبيعات باسم المنتج أو التاريخ...">
                    <button class="btn btn-primary" onclick="searchSales()">
                        <i class="fas fa-search"></i> بحث
                    </button>
                    <button class="btn btn-info" onclick="showQuickProducts('sales')">
                        <i class="fas fa-list"></i> عرض المنتجات المتوفرة
                    </button>
                </div>
                
                <form id="sales-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sale-date">التاريخ</label>
                            <input type="date" id="sale-date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="sale-time">الوقت</label>
                            <input type="time" id="sale-time" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="product-name">اسم المنتج</label>
                            <div style="position: relative;">
                                <div class="search-bar" style="margin: 0;">
                                    <input type="text" id="product-name" class="form-control" placeholder="اكتب اسم المنتج أو اختر من القائمة" required oninput="handleProductInput()">
                                    <button type="button" class="btn btn-info" onclick="showProductSelection('sales')" style="padding: 10px;">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <div id="product-suggestions" class="quick-product-select" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="product-category">الصنف</label>
                            <select id="product-category" class="form-control" required>
                                <option value="">اختر الصنف</option>
                                <!-- سيتم ملؤها بالجافاسكريبت -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sale-quantity">الكمية</label>
                            <input type="number" id="sale-quantity" class="form-control" min="0.01" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="sale-price">سعر البيع (ريال)</label>
                            <input type="number" id="sale-price" class="form-control" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="purchase-price-input">سعر الشراء (ريال)</label>
                            <input type="number" id="purchase-price-input" class="form-control" min="0" readonly>
                            <small style="color: #666;">يتم تعبئته تلقائياً من بيانات المنتج</small>
                        </div>
                        <div class="form-group">
                            <label for="payment-method">طريقة الدفع</label>
                            <select id="payment-method" class="form-control" required>
                                <option value="نقدي">نقدي</option>
                                <option value="تحويل">تحويل</option>
                                <option value="آجل">آجل</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-plus-circle"></i> إضافة عملية بيع
                        </button>
                        <button type="button" class="btn btn-primary" onclick="clearSalesForm()">
                            <i class="fas fa-broom"></i> مسح النموذج
                        </button>
                        <button type="button" class="btn btn-info" onclick="printSalesReport()">
                            <i class="fas fa-print"></i> طباعة تقرير
                        </button>
                    </div>
                </form>
                
                <div class="table-container">
                    <table id="sales-table">
                        <thead>
                            <tr>
                                <th>التاريخ والوقت</th>
                                <th>اسم المنتج</th>
                                <th>الصنف</th>
                                <th>الكمية</th>
                                <th>سعر البيع</th>
                                <th>سعر الشراء</th>
                                <th>الربح</th>
                                <th>طريقة الدفع</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="sales-table-body">
                            <!-- سيتم ملؤه بالبيانات عبر الجافاسكريبت -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- تبويب المشتريات والمخزون -->
            <div id="purchases" class="tab-content locked">
                <h2 class="section-title">
                    <i class="fas fa-boxes"></i> المشتريات والمخزون
                </h2>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>قفل مؤقت:</strong> هذا القسم محمي بكلمة مرور. الرجاء إدخال كلمة المرور للوصول.
                        <button class="btn btn-sm btn-primary" onclick="showPasswordPrompt('purchases')" style="margin-right: 10px;">
                            <i class="fas fa-lock-open"></i> فتح القسم
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- تبويب المصروفات الشهرية -->
            <div id="expenses" class="tab-content locked">
                <h2 class="section-title">
                    <i class="fas fa-money-bill-wave"></i> المصروفات الشهرية
                </h2>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>قفل مؤقت:</strong> هذا القسم محمي بكلمة مرور. الرجاء إدخال كلمة المرور للوصول.
                        <button class="btn btn-sm btn-primary" onclick="showPasswordPrompt('expenses')" style="margin-right: 10px;">
                            <i class="fas fa-lock-open"></i> فتح القسم
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- تبويب إدارة الأصناف -->
            <div id="products" class="tab-content locked">
                <h2 class="section-title">
                    <i class="fas fa-list"></i> إدارة الأصناف والمنتجات
                </h2>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>قفل مؤقت:</strong> هذا القسم محمي بكلمة مرور. الرجاء إدخال كلمة المرور للوصول.
                        <button class="btn btn-sm btn-primary" onclick="showPasswordPrompt('products')" style="margin-right: 10px;">
                            <i class="fas fa-lock-open"></i> فتح القسم
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- تبويب الملخص الشهري -->
            <div id="summary" class="tab-content locked">
                <h2 class="section-title">
                    <i class="fas fa-chart-bar"></i> الملخص الشهري والتقارير
                </h2>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>قفل مؤقت:</strong> هذا القسم محمي بكلمة مرور. الرجاء إدخال كلمة المرور للوصول.
                        <button class="btn btn-sm btn-primary" onclick="showPasswordPrompt('summary')" style="margin-right: 10px;">
                            <i class="fas fa-lock-open"></i> فتح القسم
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- تبويب النسخ الاحتياطي -->
            <div id="backup" class="tab-content locked">
                <h2 class="section-title">
                    <i class="fas fa-database"></i> النسخ الاحتياطي واستعادة البيانات
                </h2>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>قفل مؤقت:</strong> هذا القسم محمي بكلمة مرور. الرجاء إدخال كلمة المرور للوصول.
                        <button class="btn btn-sm btn-primary" onclick="showPasswordPrompt('backup')" style="margin-right: 10px;">
                            <i class="fas fa-lock-open"></i> فتح القسم
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- تبويب الأمان -->
            <div id="security" class="tab-content locked">
                <h2 class="section-title">
                    <i class="fas fa-lock"></i> إدارة الأمان وكلمة المرور
                </h2>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>قفل مؤقت:</strong> هذا القسم محمي بكلمة مرور. الرجاء إدخال كلمة المرور للوصول.
                        <button class="btn btn-sm btn-primary" onclick="showPasswordPrompt('security')" style="margin-right: 10px;">
                            <i class="fas fa-lock-open"></i> فتح القسم
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- شريط الأدوات السفلي -->
        <div class="toolbar">
            <button class="btn btn-primary" onclick="saveAllData()">
                <i class="fas fa-save"></i> حفظ البيانات
            </button>
            <button class="btn btn-success" onclick="loadAllData()">
                <i class="fas fa-sync"></i> تحديث البيانات
            </button>
            <button class="btn btn-info" onclick="window.print()">
                <i class="fas fa-print"></i> طباعة الصفحة
            </button>
            <button class="btn btn-warning" onclick="showHelp()">
                <i class="fas fa-question-circle"></i> مساعدة
            </button>
            <button class="btn btn-danger" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> خروج
            </button>
        </div>
        
        <!-- تذييل الصفحة -->
        <div class="footer">
            <div class="footer-content">
                <h3>تم تصميم هذا البرنامج بواسطة</h3>
                <p>المهندس : أسحاق فضل محمد التويتي</p>
                <p>رقم الهاتف : 967775778877+</p>
                <p class="copyright">جميع الحقوق محفوظة © 2026</p>
            </div>
        </div>
    </div>
    
    <!-- تنبيهات -->
    <div id="notification"></div>
    
    <!-- مودال إدخال كلمة المرور -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h2 class="section-title">
                <i class="fas fa-lock"></i> إدخال كلمة المرور
            </h2>
            <p id="password-prompt-text">الرجاء إدخال كلمة المرور للوصول لهذا القسم:</p>
            <div class="form-group">
                <input type="password" id="tab-password" class="form-control" placeholder="كلمة المرور">
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="checkTabPassword()">
                    <i class="fas fa-check"></i> تأكيد
                </button>
                <button class="btn btn-danger" onclick="closeModal('password-modal')">
                    <i class="fas fa-times"></i> إلغاء
                </button>
            </div>
        </div>
    </div>
    
    <!-- مودال تفاصيل الربح -->
    <div id="profit-details-modal" class="modal">
        <div class="modal-content">
            <h2 class="section-title">
                <i class="fas fa-chart-line"></i> تفاصيل الربح الحالي
            </h2>
            <div class="stats-cards">
                <div class="stat-card">
                    <h3>إجمالي المبيعات</h3>
                    <div class="value" id="profit-total-sales">0 ريال</div>
                    <div class="subtext">مجموع جميع المبيعات</div>
                </div>
                <div class="stat-card">
                    <h3>تكلفة البضاعة</h3>
                    <div class="value" id="profit-cost">0 ريال</div>
                    <div class="subtext">تكلفة المنتجات المباعة</div>
                </div>
                <div class="stat-card">
                    <h3>إجمالي الربح</h3>
                    <div class="value" id="profit-gross">0 ريال</div>
                    <div class="subtext">الفرق بين البيع والشراء</div>
                </div>
            </div>
            
            <h3 class="section-title" style="margin-top: 20px;">
                <i class="fas fa-list"></i> أحدث عمليات البيع
            </h3>
            <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>الوقت</th>
                            <th>المنتج</th>
                            <th>الكمية</th>
                            <th>الربح</th>
                        </tr>
                    </thead>
                    <tbody id="profit-recent-table">
                        <!-- سيتم ملؤه بالبيانات عبر الجافاسكريبت -->
                    </tbody>
                </table>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="closeModal('profit-details-modal')">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
        </div>
    </div>
    
    <!-- مودال إدارة كلمة المرور -->
    <div id="security-modal" class="modal">
        <div class="modal-content">
            <h2 class="section-title">
                <i class="fas fa-lock"></i> إدارة كلمة مرور النظام
            </h2>
            
            <div class="password-manager">
                <h3>تغيير كلمة المرور</h3>
                <p>يمكنك تغيير كلمة المرور للنظام كاملاً (جميع الأقسام المحمية)</p>
                <div class="password-form">
                    <input type="password" id="current-password" class="form-control" placeholder="كلمة المرور الحالية">
                    <input type="password" id="new-password" class="form-control" placeholder="كلمة المرور الجديدة">
                    <input type="password" id="confirm-password" class="form-control" placeholder="تأكيد كلمة المرور الجديدة">
                </div>
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="changePassword()">
                        <i class="fas fa-key"></i> تغيير كلمة المرور
                    </button>
                </div>
            </div>
            
            <div class="password-manager">
                <h3>إعدادات الأمان</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="auto-logout" checked>
                        تسجيل الخروج التلقائي بعد 30 دقيقة من عدم النشاط
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="require-password-sales" checked>
                        طلب كلمة مرور لتعديل أو حذف عمليات البيع
                    </label>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="closeModal('security-modal')">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
        </div>
    </div>
    
    <!-- مودال المساعدة -->
    <div id="help-modal" class="modal">
        <div class="modal-content">
            <h2 class="section-title">
                <i class="fas fa-question-circle"></i> مساعدة استخدام النظام
            </h2>
            <div style="line-height: 1.8;">
                <p><strong>الميزات الجديدة:</strong></p>
                <ul style="margin-right: 20px; margin-bottom: 20px;">
                    <li><strong>الربح المباشر:</strong> عرض الربح الحالي بعد كل عملية بيع</li>
                    <li><strong>نظام كلمة المرور:</strong> حماية جميع الأقسام عدا المبيعات</li>
                    <li><strong>حساب الربح التلقائي:</strong> حساب الفرق بين سعر البيع والشراء</li>
                    <li><strong>تفاصيل الربح:</strong> عرض تفاصيل الربح مع أحدث العمليات</li>
                    <li><strong>حفظ تلقائي:</strong> يتم حفظ البيانات تلقائياً بعد كل عملية</li>
                </ul>
                
                <p><strong>كيفية استخدام النظام:</strong></p>
                <ol style="margin-right: 20px; margin-bottom: 20px;">
                    <li>يمكن الدخول للمبيعات مباشرة بدون كلمة مرور</li>
                    <li>للدخول للأقسام الأخرى، استخدم كلمة المرور الافتراضية: <strong>123456</strong></li>
                    <li>يمكنك تغيير كلمة المرور من قسم الأمان</li>
                    <li>الربح الحالي يظهر في أعلى الصفحة ويتحدد تلقائياً</li>
                    <li>يمكنك رؤية تفاصيل الربح بالضغط على زر المعلومات</li>
                    <li>يتم حفظ البيانات تلقائياً، ولكن يمكنك استخدام زر "حفظ البيانات" للتأكيد</li>
                </ol>
                
                <p><strong>نصائح مهمة:</strong></p>
                <ul style="margin-right: 20px; margin-bottom: 20px;">
                    <li>احفظ كلمة المرور الجديدة في مكان آمن</li>
                    <li>الربح السلبي يظهر باللون الأحمر (خسارة)</li>
                    <li>يمكن إدخال سعر الشراء يدوياً أو حسابه تلقائياً</li>
                    <li>قم بحفظ البيانات بانتظام باستخدام زر الحفظ</li>
                    <li>استخدم النسخ الاحتياطي لحماية بياناتك</li>
                </ul>
            </div>
            <button class="btn btn-primary" onclick="closeModal('help-modal')" style="margin-top: 20px;">
                <i class="fas fa-times"></i> إغلاق
            </button>
        </div>
    </div>

    <script>
        // بيانات التطبيق
        let salesData = [];
        let purchasesData = [];
        let expensesData = [];
        let productsData = [];
        let categories = ['مواد غذائية', 'بهارات', 'معلبات', 'مشروبات', 'منظفات', 'أخرى'];
        let units = ['كيلو', 'جرام', 'لتر', 'علبة', 'كرتون', 'حبة', 'أخرى'];
        
        // بيانات الأمان
        let systemPassword = "123456"; // كلمة المرور الافتراضية
        let isLoggedIn = false;
        let unlockedTabs = ['sales']; // تبويب المبيعات مفتوح دائماً
        let currentTabToUnlock = null;
        let lastActivityTime = Date.now();
        
        // متغيرات الربح
        let currentProfit = 0;
        let todayProfit = 0;
        
        let currentSaleId = null;
        let currentPurchaseId = null;
        let currentExpenseId = null;
        let currentProductId = null;
        let currentCategoryToDelete = null;
        
        // تهيئة التطبيق عند التحميل
        document.addEventListener('DOMContentLoaded', function() {
            // تحميل كلمة المرور المحفوظة
            loadSecuritySettings();
            
            // إعداد مستمع للنشاط
            document.addEventListener('click', updateActivityTime);
            document.addEventListener('keypress', updateActivityTime);
            
            // بدء مراقبة وقت النشاط
            startActivityMonitor();
            
            // إعداد وحدة التخزين المحلية
            if (typeof(Storage) !== "undefined") {
                console.log("المتصفح يدعم التخزين المحلي");
            } else {
                showNotification("المتصفح لا يدعم التخزين المحلي، سيتم فقدان البيانات عند إغلاق الصفحة", "warning");
            }
        });
        
        // تحديث وقت النشاط
        function updateActivityTime() {
            lastActivityTime = Date.now();
        }
        
        // مراقبة النشاط للتسجيل التلقائي
        function startActivityMonitor() {
            setInterval(function() {
                const now = Date.now();
                const inactiveTime = (now - lastActivityTime) / 1000 / 60; // بالدقائق
                
                if (isLoggedIn && inactiveTime > 30) { // 30 دقيقة
                    showNotification('تم تسجيل الخروج تلقائياً بسبب عدم النشاط', 'warning');
                    logout();
                }
            }, 60000); // التحقق كل دقيقة
        }
        
        // تسجيل الدخول للنظام كاملاً
        function login() {
            const password = document.getElementById('login-password').value;
            
            if (password === systemPassword) {
                isLoggedIn = true;
                unlockedTabs = ['sales', 'purchases', 'expenses', 'products', 'summary', 'backup', 'security'];
                showMainSystem();
                showNotification('تم تسجيل الدخول بنجاح', 'success');
                document.getElementById('login-password').value = ''; // مسح كلمة المرور
            } else {
                showNotification('كلمة المرور غير صحيحة', 'danger');
                document.getElementById('login-password').value = ''; // مسح كلمة المرور
            }
        }
        
        // الدخول للمبيعات فقط
        function enterSalesOnly() {
            isLoggedIn = false;
            unlockedTabs = ['sales'];
            showMainSystem();
            showNotification('تم الدخول لقسم المبيعات فقط', 'info');
            document.getElementById('login-password').value = ''; // مسح كلمة المرور
        }
        
        // تسجيل الخروج
        function logout() {
            isLoggedIn = false;
            unlockedTabs = ['sales'];
            document.getElementById('main-system').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            showNotification('تم تسجيل الخروج', 'info');
        }
        
        // إظهار النظام الرئيسي
        function showMainSystem() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-system').style.display = 'block';
            
            // تحديث التاريخ والوقت الحالي
            updateDateTime();
            setInterval(updateDateTime, 60000);
            
            // تعيين التاريخ والوقت الحالي في حقول الإدخال
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const time = now.toTimeString().substring(0, 5);
            
            document.getElementById('sale-date').value = today;
            document.getElementById('sale-time').value = time;
            
            // تحميل البيانات المخزنة
            loadAllData();
            
            // إعداد مستمعي النماذج
            const salesForm = document.getElementById('sales-form');
            if (salesForm) {
                salesForm.addEventListener('submit', addSale);
            }
            
            // إعداد مستمعي علامات التبويب
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    openTab(tabId);
                });
            });
            
            // تحديث الإحصائيات
            updateStats();
            
            // تحديث عرض الربح
            updateProfitDisplay();
            
            // تحديث حالة التبويبات
            updateTabSecurity();
        }
        
        // تحديث حالة التبويبات (مقفلة/مفتوحة)
        function updateTabSecurity() {
            document.querySelectorAll('.tab').forEach(tab => {
                const tabId = tab.getAttribute('data-tab');
                
                if (unlockedTabs.includes(tabId)) {
                    tab.classList.remove('locked');
                    document.getElementById(tabId).classList.remove('locked');
                } else {
                    tab.classList.add('locked');
                    document.getElementById(tabId).classList.add('locked');
                }
            });
        }
        
        // فتح تبويب
        function openTab(tabId) {
            // التحقق إذا كان التبويب مقفلاً
            if (!unlockedTabs.includes(tabId) && tabId !== 'sales') {
                currentTabToUnlock = tabId;
                showPasswordPrompt(tabId);
                return;
            }
            
            // إخفاء جميع المحتويات
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // إلغاء تنشيط جميع علامات التبويب
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إظهار المحتوى المطلوب
            document.getElementById(tabId).classList.add('active');
            
            // تنشيط علامة التبويب
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            
            // تحديث المحتوى حسب التبويب
            switch(tabId) {
                case 'sales':
                    updateCategoriesFilter('sales');
                    break;
                case 'purchases':
                    loadPurchasesContent();
                    break;
                case 'expenses':
                    loadExpensesContent();
                    break;
                case 'products':
                    loadProductsContent();
                    break;
                case 'summary':
                    loadSummaryContent();
                    break;
                case 'backup':
                    loadBackupContent();
                    break;
                case 'security':
                    loadSecurityContent();
                    break;
            }
        }
        
        // إظهار طلب كلمة المرور
        function showPasswordPrompt(tabId) {
            currentTabToUnlock = tabId;
            const tabNames = {
                'purchases': 'المشتريات',
                'expenses': 'المصروفات',
                'products': 'إدارة الأصناف',
                'summary': 'التقارير',
                'backup': 'النسخ الاحتياطي',
                'security': 'الأمان'
            };
            
            document.getElementById('password-prompt-text').textContent = 
                `الرجاء إدخال كلمة المرور للوصول لقسم ${tabNames[tabId]}:`;
            
            document.getElementById('password-modal').style.display = 'flex';
            document.getElementById('tab-password').value = ''; // مسح كلمة المرور
            document.getElementById('tab-password').focus();
        }
        
        // التحقق من كلمة مرور التبويب
        function checkTabPassword() {
            const password = document.getElementById('tab-password').value;
            
            if (password === systemPassword) {
                // فتح التبويب
                if (!unlockedTabs.includes(currentTabToUnlock)) {
                    unlockedTabs.push(currentTabToUnlock);
                }
                updateTabSecurity();
                closeModal('password-modal');
                openTab(currentTabToUnlock);
                showNotification('تم فتح القسم بنجاح', 'success');
                document.getElementById('tab-password').value = ''; // مسح كلمة المرور
            } else {
                showNotification('كلمة المرور غير صحيحة', 'danger');
                document.getElementById('tab-password').value = ''; // مسح كلمة المرور
            }
        }
        
        // تحميل محتوى المشتريات
        function loadPurchasesContent() {
            const content = document.getElementById('purchases');
            
            // إذا كان محتوى القفل موجود، استبدله بالمحتوى الحقيقي
            if (content.querySelector('.alert')) {
                content.innerHTML = `
                    <h2 class="section-title">
                        <i class="fas fa-boxes"></i> المشتريات والمخزون
                    </h2>
                    
                    <div class="stats-cards">
                        <div class="stat-card">
                            <h3>قيمة المشتريات</h3>
                            <div class="value" id="total-purchases">0 ريال</div>
                            <div class="subtext">إجمالي المشتريات هذا الشهر</div>
                        </div>
                        <div class="stat-card">
                            <h3>عدد المنتجات</h3>
                            <div class="value" id="total-products">0</div>
                            <div class="subtext">منتج في المخزون</div>
                        </div>
                        <div class="stat-card">
                            <h3>المنتجات المنخفضة</h3>
                            <div class="value" id="low-stock">0</div>
                            <div class="subtext">منتج يحتاج للتزويد</div>
                        </div>
                    </div>
                    
                    <!-- الأصناف السريعة -->
                    <div class="quick-categories" id="purchases-categories">
                        <div class="category-chip active" data-category="all">جميع الأصناف</div>
                    </div>
                    
                    <form id="purchase-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="purchase-date">تاريخ الشراء</label>
                                <input type="date" id="purchase-date" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="purchase-time">وقت الشراء</label>
                                <input type="time" id="purchase-time" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="purchase-product">اسم المنتج</label>
                                <div style="position: relative;">
                                    <div class="search-bar" style="margin: 0;">
                                        <input type="text" id="purchase-product" class="form-control" placeholder="اكتب اسم المنتج أو اختر من القائمة" required oninput="handleProductInput('purchases')">
                                        <button type="button" class="btn btn-info" onclick="showProductSelection('purchases')" style="padding: 10px;">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                    <div id="purchase-product-suggestions" class="quick-product-select" style="display: none;"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="supplier">المورد</label>
                                <input type="text" id="supplier" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="purchase-quantity">الكمية</label>
                                <input type="number" id="purchase-quantity" class="form-control" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="purchase-price">سعر الشراء (ريال)</label>
                                <input type="number" id="purchase-price" class="form-control" min="1" required>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-plus-circle"></i> إضافة عملية شراء
                            </button>
                            <button type="button" class="btn btn-primary" onclick="clearPurchaseForm()">
                                <i class="fas fa-broom"></i> مسح النموذج
                            </button>
                        </div>
                    </form>
                    
                    <div class="search-bar">
                        <input type="text" id="search-purchases" placeholder="ابحث في المشتريات...">
                        <button class="btn btn-primary" onclick="searchPurchases()">
                            <i class="fas fa-search"></i> بحث
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table id="purchases-table">
                            <thead>
                                <tr>
                                    <th>التاريخ والوقت</th>
                                    <th>اسم المنتج</th>
                                    <th>المورد</th>
                                    <th>الكمية</th>
                                    <th>سعر الشراء</th>
                                    <th>الإجمالي</th>
                                    <th>المخزون الحالي</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="purchases-table-body">
                            </tbody>
                        </table>
                    </div>
                `;
                
                // إعداد نموذج المشتريات
                document.getElementById('purchase-form').addEventListener('submit', addPurchase);
                
                // تحديث الوقت والتاريخ
                const now = new Date();
                const purchaseDateInput = document.getElementById('purchase-date');
                const purchaseTimeInput = document.getElementById('purchase-time');
                
                if (purchaseDateInput) purchaseDateInput.value = now.toISOString().split('T')[0];
                if (purchaseTimeInput) purchaseTimeInput.value = now.toTimeString().substring(0, 5);
                
                // تحديث الجداول
                updatePurchasesTable();
                updateCategoriesFilter('purchases');
                updatePurchasesStats();
            }
        }
        
        // إضافة عملية شراء
        function addPurchase(e) {
            e.preventDefault();
            
            const purchase = {
                id: currentPurchaseId || Date.now(),
                date: document.getElementById('purchase-date').value,
                time: document.getElementById('purchase-time').value,
                productName: document.getElementById('purchase-product').value,
                supplier: document.getElementById('supplier').value,
                quantity: parseInt(document.getElementById('purchase-quantity').value),
                price: parseInt(document.getElementById('purchase-price').value),
                timestamp: new Date().getTime()
            };
            
            purchase.total = purchase.quantity * purchase.price;
            
            // تحديث سعر الشراء في بيانات المنتج إذا كان موجوداً
            const productIndex = productsData.findIndex(p => p.name === purchase.productName);
            if (productIndex !== -1) {
                productsData[productIndex].purchasePrice = purchase.price;
            }
            
            if (currentPurchaseId) {
                // تعديل عملية شراء موجودة
                const index = purchasesData.findIndex(p => p.id === currentPurchaseId);
                if (index !== -1) {
                    purchasesData[index] = purchase;
                    showNotification('تم تعديل عملية الشراء بنجاح', 'success');
                }
                currentPurchaseId = null;
            } else {
                // إضافة عملية شراء جديدة
                purchasesData.push(purchase);
                showNotification('تم إضافة عملية الشراء بنجاح', 'success');
            }
            
            // تحديث الجدول
            updatePurchasesTable();
            
            // مسح النموذج
            clearPurchaseForm();
            
            // حفظ البيانات
            saveAllData();
        }
        
        // تعديل عملية شراء
        function editPurchase(id) {
            const purchase = purchasesData.find(p => p.id === id);
            if (!purchase) return;
            
            currentPurchaseId = id;
            document.getElementById('purchase-date').value = purchase.date;
            document.getElementById('purchase-time').value = purchase.time;
            document.getElementById('purchase-product').value = purchase.productName;
            document.getElementById('supplier').value = purchase.supplier;
            document.getElementById('purchase-quantity').value = purchase.quantity;
            document.getElementById('purchase-price').value = purchase.price;
            
            showNotification('تم تحميل عملية الشراء للتعديل', 'info');
        }
        
        // حذف عملية شراء
        function deletePurchase(id) {
            if (confirm('هل أنت متأكد من حذف عملية الشراء هذه؟')) {
                const index = purchasesData.findIndex(p => p.id === id);
                if (index !== -1) {
                    purchasesData.splice(index, 1);
                    updatePurchasesTable();
                    saveAllData();
                    showNotification('تم حذف عملية الشراء بنجاح', 'success');
                }
            }
        }
        
        // مسح نموذج المشتريات
        function clearPurchaseForm() {
            const form = document.getElementById('purchase-form');
            if (form) {
                form.reset();
                const now = new Date();
                const purchaseDateInput = document.getElementById('purchase-date');
                const purchaseTimeInput = document.getElementById('purchase-time');
                
                if (purchaseDateInput) purchaseDateInput.value = now.toISOString().split('T')[0];
                if (purchaseTimeInput) purchaseTimeInput.value = now.toTimeString().substring(0, 5);
                
                currentPurchaseId = null;
                const suggestions = document.getElementById('purchase-product-suggestions');
                if (suggestions) suggestions.style.display = 'none';
            }
        }
        
        // تحميل محتوى المصروفات
        function loadExpensesContent() {
            const content = document.getElementById('expenses');
            
            if (content.querySelector('.alert')) {
                content.innerHTML = `
                    <h2 class="section-title">
                        <i class="fas fa-money-bill-wave"></i> المصروفات الشهرية
                    </h2>
                    
                    <div class="stats-cards">
                        <div class="stat-card">
                            <h3>المصروفات الشهرية</h3>
                            <div class="value" id="monthly-expenses">0 ريال</div>
                            <div class="subtext">إجمالي مصروفات هذا الشهر</div>
                        </div>
                        <div class="stat-card">
                            <h3>أعلى مصروف</h3>
                            <div class="value" id="highest-expense">0 ريال</div>
                            <div class="subtext">أكبر مصروف هذا الشهر</div>
                        </div>
                        <div class="stat-card">
                            <h3>متوسط المصروفات</h3>
                            <div class="value" id="avg-expense">0 ريال</div>
                            <div class="subtext">متوسط المصروفات اليومية</div>
                        </div>
                    </div>
                    
                    <form id="expense-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expense-date">التاريخ</label>
                                <input type="date" id="expense-date" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="expense-time">الوقت</label>
                                <input type="time" id="expense-time" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="expense-type">نوع المصروف</label>
                                <select id="expense-type" class="form-control" required>
                                    <option value="">اختر نوع المصروف</option>
                                    <option value="إيجار المحل">إيجار المحل</option>
                                    <option value="كهرباء">كهرباء</option>
                                    <option value="مرتب موظف">مرتب موظف</option>
                                    <option value="صيانة">صيانة</option>
                                    <option value="نقل وشحن">نقل وشحن</option>
                                    <option value="أخرى">أخرى</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="expense-amount">المبلغ (ريال)</label>
                                <input type="number" id="expense-amount" class="form-control" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="expense-notes">ملاحظات</label>
                                <input type="text" id="expense-notes" class="form-control" placeholder="ملاحظات إضافية">
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-plus-circle"></i> إضافة مصروف
                            </button>
                            <button type="button" class="btn btn-primary" onclick="clearExpenseForm()">
                                <i class="fas fa-broom"></i> مسح النموذج
                            </button>
                        </div>
                    </form>
                    
                    <div class="search-bar">
                        <input type="text" id="search-expenses" placeholder="ابحث في المصروفات...">
                        <button class="btn btn-primary" onclick="searchExpenses()">
                            <i class="fas fa-search"></i> بحث
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table id="expenses-table">
                            <thead>
                                <tr>
                                    <th>التاريخ والوقت</th>
                                    <th>نوع المصروف</th>
                                    <th>المبلغ (ريال)</th>
                                    <th>ملاحظات</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="expenses-table-body">
                            </tbody>
                        </table>
                    </div>
                `;
                
                // إعداد نموذج المصروفات
                document.getElementById('expense-form').addEventListener('submit', addExpense);
                
                // تحديث الوقت والتاريخ
                const now = new Date();
                const expenseDateInput = document.getElementById('expense-date');
                const expenseTimeInput = document.getElementById('expense-time');
                
                if (expenseDateInput) expenseDateInput.value = now.toISOString().split('T')[0];
                if (expenseTimeInput) expenseTimeInput.value = now.toTimeString().substring(0, 5);
                
                // تحديث الجداول
                updateExpensesTable();
                updateExpensesStats();
            }
        }
        
        // إضافة مصروف
        function addExpense(e) {
            e.preventDefault();
            
            const expense = {
                id: currentExpenseId || Date.now(),
                date: document.getElementById('expense-date').value,
                time: document.getElementById('expense-time').value,
                type: document.getElementById('expense-type').value,
                amount: parseInt(document.getElementById('expense-amount').value),
                notes: document.getElementById('expense-notes').value || '',
                timestamp: new Date().getTime()
            };
            
            if (currentExpenseId) {
                // تعديل مصروف موجود
                const index = expensesData.findIndex(e => e.id === currentExpenseId);
                if (index !== -1) {
                    expensesData[index] = expense;
                    showNotification('تم تعديل المصروف بنجاح', 'success');
                }
                currentExpenseId = null;
            } else {
                // إضافة مصروف جديد
                expensesData.push(expense);
                showNotification('تم إضافة المصروف بنجاح', 'success');
            }
            
            // تحديث الجدول
            updateExpensesTable();
            
            // مسح النموذج
            clearExpenseForm();
            
            // حفظ البيانات
            saveAllData();
        }
        
        // تعديل مصروف
        function editExpense(id) {
            const expense = expensesData.find(e => e.id === id);
            if (!expense) return;
            
            currentExpenseId = id;
            document.getElementById('expense-date').value = expense.date;
            document.getElementById('expense-time').value = expense.time;
            document.getElementById('expense-type').value = expense.type;
            document.getElementById('expense-amount').value = expense.amount;
            document.getElementById('expense-notes').value = expense.notes || '';
            
            showNotification('تم تحميل المصروف للتعديل', 'info');
        }
        
        // حذف مصروف
        function deleteExpense(id) {
            if (confirm('هل أنت متأكد من حذف المصروف هذا؟')) {
                const index = expensesData.findIndex(e => e.id === id);
                if (index !== -1) {
                    expensesData.splice(index, 1);
                    updateExpensesTable();
                    saveAllData();
                    showNotification('تم حذف المصروف بنجاح', 'success');
                }
            }
        }
        
        // مسح نموذج المصروفات
        function clearExpenseForm() {
            const form = document.getElementById('expense-form');
            if (form) {
                form.reset();
                const now = new Date();
                const expenseDateInput = document.getElementById('expense-date');
                const expenseTimeInput = document.getElementById('expense-time');
                
                if (expenseDateInput) expenseDateInput.value = now.toISOString().split('T')[0];
                if (expenseTimeInput) expenseTimeInput.value = now.toTimeString().substring(0, 5);
                
                currentExpenseId = null;
            }
        }
        
        // تحميل محتوى المنتجات
        function loadProductsContent() {
            const content = document.getElementById('products');
            
            if (content.querySelector('.alert')) {
                content.innerHTML = `
                    <h2 class="section-title">
                        <i class="fas fa-list"></i> إدارة الأصناف والمنتجات
                    </h2>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>مهم:</strong> من هنا يمكنك إضافة وإدارة جميع الأصناف والمنتجات المتوفرة في المحل. عند إضافة منتج جديد، سيظهر في قائمة المنتجات عند تسجيل المبيعات والمشتريات.
                        </div>
                    </div>
                    
                    <div class="stats-cards">
                        <div class="stat-card">
                            <h3>عدد الأصناف</h3>
                            <div class="value" id="total-categories">0</div>
                            <div class="subtext">صنف مختلف في النظام</div>
                        </div>
                        <div class="stat-card">
                            <h3>عدد المنتجات</h3>
                            <div class="value" id="total-products-items">0</div>
                            <div class="subtext">منتج مسجل في النظام</div>
                        </div>
                        <div class="stat-card">
                            <h3>أعلى ربح</h3>
                            <div class="value" id="highest-profit">0 ريال</div>
                            <div class="subtext">أعلى ربح لمنتج</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <h3 class="section-title">
                                <i class="fas fa-plus-circle"></i> إضافة صنف جديد
                            </h3>
                            <div class="search-bar">
                                <input type="text" id="new-category" placeholder="أدخل اسم صنف جديد (مثال: بهارات، مواد غذائية، مشروبات)">
                                <button class="btn btn-success" onclick="addNewCategory()">
                                    <i class="fas fa-plus"></i> إضافة صنف
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- عرض الأصناف المتاحة -->
                    <div class="form-row">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <h3 class="section-title">
                                <i class="fas fa-tags"></i> الأصناف المتاحة
                            </h3>
                            <div class="categories-container" id="categories-container">
                                <!-- سيتم ملؤها بالجافاسكريبت -->
                            </div>
                        </div>
                    </div>
                    
                    <form id="product-form">
                        <h3 class="section-title">
                            <i class="fas fa-box"></i> إضافة منتج جديد
                        </h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="product-name-input">اسم المنتج *</label>
                                <input type="text" id="product-name-input" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="product-category-input">الصنف *</label>
                                <select id="product-category-input" class="form-control" required>
                                    <option value="">اختر الصنف</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="product-code">كود المنتج (اختياري)</label>
                                <input type="text" id="product-code" class="form-control" placeholder="BAR-001">
                            </div>
                            <div class="form-group">
                                <label for="purchase-price-product">سعر الشراء الافتراضي (ريال)</label>
                                <input type="number" id="purchase-price-product" class="form-control" min="1">
                            </div>
                            <div class="form-group">
                                <label for="sale-price-product">سعر البيع الافتراضي (ريال) *</label>
                                <input type="number" id="sale-price-product" class="form-control" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="min-stock">الحد الأدنى للمخزون</label>
                                <input type="number" id="min-stock" class="form-control" min="0" value="5">
                            </div>
                            <div class="form-group">
                                <label for="product-unit">وحدة القياس</label>
                                <select id="product-unit" class="form-control">
                                    <option value="كيلو">كيلو</option>
                                    <option value="جرام">جرام</option>
                                    <option value="لتر">لتر</option>
                                    <option value="علبة">علبة</option>
                                    <option value="كرتون">كرتون</option>
                                    <option value="حبة">حبة</option>
                                    <option value="أخرى">أخرى</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="product-description">وصف المنتج (اختياري)</label>
                                <textarea id="product-description" class="form-control" rows="2" placeholder="وصف مختصر للمنتج"></textarea>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-plus-circle"></i> إضافة منتج جديد
                            </button>
                            <button type="button" class="btn btn-primary" onclick="clearProductForm()">
                                <i class="fas fa-broom"></i> مسح النموذج
                            </button>
                        </div>
                    </form>
                    
                    <div class="search-bar">
                        <input type="text" id="search-products" placeholder="ابحث في المنتجات...">
                        <button class="btn btn-primary" onclick="searchProducts()">
                            <i class="fas fa-search"></i> بحث
                        </button>
                        <button class="btn btn-purple" onclick="exportProducts()">
                            <i class="fas fa-file-export"></i> تصدير المنتجات
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table id="products-table">
                            <thead>
                                <tr>
                                    <th>اسم المنتج</th>
                                    <th>الصنف</th>
                                    <th>كود المنتج</th>
                                    <th>سعر الشراء</th>
                                    <th>سعر البيع</th>
                                    <th>الربح</th>
                                    <th>وحدة القياس</th>
                                    <th>الحد الأدنى</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="products-table-body">
                            </tbody>
                        </table>
                    </div>
                `;
                
                // إعداد نموذج المنتجات
                document.getElementById('product-form').addEventListener('submit', addProduct);
                
                // تحديث القوائم
                updateCategoriesSelect();
                updateProductsTable();
                updateProductsStats();
                updateCategoriesDisplay();
            }
        }
        
        // تحديث عرض الأصناف
        function updateCategoriesDisplay() {
            const container = document.getElementById('categories-container');
            if (!container) return;
            
            let html = '<div class="categories-list">';
            
            if (categories.length === 0) {
                html += '<div class="alert alert-info">لا توجد أصناف مضافة بعد</div>';
            } else {
                html += '<div class="quick-categories">';
                categories.forEach(category => {
                    // حساب عدد المنتجات في هذا الصنف
                    const productCount = productsData.filter(p => p.category === category).length;
                    html += `
                        <div class="category-item">
                            <div class="category-chip">
                                ${category}
                                <span class="product-count">(${productCount} منتج)</span>
                            </div>
                            <div class="category-actions">
                                <button class="btn btn-sm btn-danger" onclick="deleteCategory('${category}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // إضافة صنف جديد
        function addNewCategory() {
            const categoryInput = document.getElementById('new-category');
            if (!categoryInput) return;
            
            const categoryName = categoryInput.value.trim();
            
            if (!categoryName) {
                showNotification('يرجى إدخال اسم الصنف', 'warning');
                return;
            }
            
            if (categories.includes(categoryName)) {
                showNotification('هذا الصنف موجود مسبقاً', 'warning');
                return;
            }
            
            categories.push(categoryName);
            updateCategoriesSelect();
            updateCategoriesFilter('sales');
            updateCategoriesFilter('purchases');
            updateCategoriesDisplay();
            
            categoryInput.value = '';
            showNotification(`تم إضافة الصنف "${categoryName}" بنجاح`, 'success');
            saveAllData();
        }
        
        // حذف صنف
        function deleteCategory(categoryName) {
            // التحقق من وجود منتجات في هذا الصنف
            const productsInCategory = productsData.filter(p => p.category === categoryName);
            
            if (productsInCategory.length > 0) {
                showNotification(`لا يمكن حذف الصنف "${categoryName}" لأنه يحتوي على ${productsInCategory.length} منتج`, 'warning');
                return;
            }
            
            if (confirm(`هل أنت متأكد من حذف الصنف "${categoryName}"؟`)) {
                const index = categories.indexOf(categoryName);
                if (index !== -1) {
                    categories.splice(index, 1);
                    updateCategoriesSelect();
                    updateCategoriesFilter('sales');
                    updateCategoriesFilter('purchases');
                    updateCategoriesDisplay();
                    saveAllData();
                    showNotification(`تم حذف الصنف "${categoryName}" بنجاح`, 'success');
                }
            }
        }
        
        // تحديث قائمة التصنيفات في select
        function updateCategoriesSelect() {
            const categorySelects = [
                'product-category',
                'product-category-input'
            ];
            
            categorySelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">اختر الصنف</option>' +
                        categories.map(cat => `<option value="${cat}" ${cat === currentValue ? 'selected' : ''}>${cat}</option>`).join('');
                }
            });
        }
        
        // تحديث مرشحات الأصناف
        function updateCategoriesFilter(type) {
            const containerId = type === 'sales' ? 'sales-categories' : 'purchases-categories';
            const container = document.getElementById(containerId);
            
            if (!container) return;
            
            // إضافة "الكل" أولاً
            let html = '<div class="category-chip active" data-category="all">جميع الأصناف</div>';
            
            // إضافة الأصناف
            categories.forEach(category => {
                html += `<div class="category-chip" data-category="${category}">${category}</div>`;
            });
            
            container.innerHTML = html;
            
            // إضافة مستمعي الأحداث
            container.querySelectorAll('.category-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    // إزالة النشاط من جميع الرقائق
                    container.querySelectorAll('.category-chip').forEach(c => c.classList.remove('active'));
                    // إضافة النشاط للرقاقة المختارة
                    this.classList.add('active');
                    
                    const selectedCategory = this.getAttribute('data-category');
                    filterByCategory(type, selectedCategory);
                });
            });
        }
        
        // تصفية حسب الصنف
        function filterByCategory(type, category) {
            if (category === 'all') {
                if (type === 'sales') {
                    updateSalesTable();
                } else {
                    updatePurchasesTable();
                }
                return;
            }
            
            if (type === 'sales') {
                const filtered = salesData.filter(sale => sale.category === category);
                updateSalesTable(filtered);
            } else {
                const filtered = purchasesData.filter(purchase => {
                    const product = productsData.find(p => p.name === purchase.productName);
                    return product && product.category === category;
                });
                updatePurchasesTable(filtered);
            }
        }
        
        // إضافة منتج جديد
        function addProduct(e) {
            e.preventDefault();
            
            const product = {
                id: currentProductId || Date.now(),
                name: document.getElementById('product-name-input').value,
                category: document.getElementById('product-category-input').value,
                code: document.getElementById('product-code').value || '',
                purchasePrice: parseInt(document.getElementById('purchase-price-product').value) || 0,
                salePrice: parseInt(document.getElementById('sale-price-product').value),
                unit: document.getElementById('product-unit').value,
                minStock: parseInt(document.getElementById('min-stock').value) || 0,
                description: document.getElementById('product-description').value || '',
                createdAt: new Date().toISOString()
            };
            
            // حساب الربح للمنتج
            product.profit = product.salePrice - product.purchasePrice;
            
            // التحقق من عدم تكرار اسم المنتج
            const existingProduct = productsData.find(p => 
                p.name.toLowerCase() === product.name.toLowerCase() && p.id !== currentProductId
            );
            
            if (existingProduct && !currentProductId) {
                showNotification('هذا المنتج مسجل مسبقاً في النظام', 'warning');
                return;
            }
            
            if (currentProductId) {
                // تعديل منتج موجود
                const index = productsData.findIndex(p => p.id === currentProductId);
                if (index !== -1) {
                    productsData[index] = product;
                    showNotification('تم تعديل المنتج بنجاح', 'success');
                }
                currentProductId = null;
            } else {
                // إضافة منتج جديد
                productsData.push(product);
                showNotification('تم إضافة المنتج بنجاح', 'success');
                
                // إضافة الصنف إذا كان جديداً
                if (!categories.includes(product.category)) {
                    categories.push(product.category);
                    updateCategoriesSelect();
                    updateCategoriesFilter('sales');
                    updateCategoriesFilter('purchases');
                    updateCategoriesDisplay();
                }
            }
            
            // تحديث الجداول
            updateProductsTable();
            updateProductsStats();
            
            // مسح النموذج
            clearProductForm();
            
            // حفظ البيانات
            saveAllData();
        }
        
        // تعديل منتج
        function editProduct(id) {
            const product = productsData.find(p => p.id === id);
            if (!product) return;
            
            currentProductId = id;
            document.getElementById('product-name-input').value = product.name;
            document.getElementById('product-category-input').value = product.category;
            document.getElementById('product-code').value = product.code || '';
            document.getElementById('purchase-price-product').value = product.purchasePrice || '';
            document.getElementById('sale-price-product').value = product.salePrice;
            document.getElementById('min-stock').value = product.minStock || 5;
            document.getElementById('product-unit').value = product.unit || 'كيلو';
            document.getElementById('product-description').value = product.description || '';
            
            showNotification('تم تحميل المنتج للتعديل', 'info');
        }
        
        // حذف منتج
        function deleteProduct(id) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                const index = productsData.findIndex(p => p.id === id);
                if (index !== -1) {
                    productsData.splice(index, 1);
                    updateProductsTable();
                    updateCategoriesDisplay();
                    saveAllData();
                    showNotification('تم حذف المنتج بنجاح', 'success');
                }
            }
        }
        
        // مسح نموذج المنتجات
        function clearProductForm() {
            const form = document.getElementById('product-form');
            if (form) {
                form.reset();
                const minStockInput = document.getElementById('min-stock');
                const unitSelect = document.getElementById('product-unit');
                
                if (minStockInput) minStockInput.value = 5;
                if (unitSelect) unitSelect.value = 'كيلو';
                
                currentProductId = null;
            }
        }
        
        // تحميل محتوى الملخص
        function loadSummaryContent() {
            const content = document.getElementById('summary');
            
            if (content.querySelector('.alert')) {
                content.innerHTML = `
                    <h2 class="section-title">
                        <i class="fas fa-chart-bar"></i> الملخص الشهري والتقارير
                    </h2>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>ملاحظة:</strong> يتم حساب الملخص الشهري بناءً على البيانات المسجلة في النظام. يمكنك تحديد الشهر المراد عرض تقريره أدناه.
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="summary-month">اختر الشهر</label>
                            <input type="month" id="summary-month" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="summary-year">اختر السنة</label>
                            <input type="number" id="summary-year" class="form-control" min="2023" max="2030" value="2024">
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="generateMonthlySummary()">
                            <i class="fas fa-calculator"></i> إنشاء التقرير الشهري
                        </button>
                        <button type="button" class="btn btn-success" onclick="printSummary()">
                            <i class="fas fa-print"></i> طباعة التقرير
                        </button>
                        <button type="button" class="btn btn-info" onclick="generateInventoryReport()">
                            <i class="fas fa-clipboard-list"></i> تقرير المخزون
                        </button>
                    </div>
                    
                    <div class="stats-cards">
                        <div class="stat-card">
                            <h3>إجمالي المبيعات</h3>
                            <div class="value" id="summary-sales">0 ريال</div>
                            <div class="subtext">مبيعات الشهر المحدد</div>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي المشتريات</h3>
                            <div class="value" id="summary-purchases">0 ريال</div>
                            <div class="subtext">مشتريات الشهر المحدد</div>
                        </div>
                        <div class="stat-card">
                            <h3>مجمل الربح</h3>
                            <div class="value" id="summary-gross">0 ريال</div>
                            <div class="subtext">= المبيعات - المشتريات</div>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي المصروفات</h3>
                            <div class="value" id="summary-expenses">0 ريال</div>
                            <div class="subtext">مصروفات الشهر المحدد</div>
                        </div>
                    </div>
                    
                    <div class="stat-card" style="margin-top: 20px; grid-column: 1 / -1;">
                        <h3>صافي الربح</h3>
                        <div class="value" id="summary-net">0 ريال</div>
                        <div class="subtext">= مجمل الربح - المصروفات</div>
                    </div>
                    
                    <div class="table-container" style="margin-top: 30px;">
                        <h3 class="section-title">
                            <i class="fas fa-list"></i> تفاصيل المبيعات الشهرية
                        </h3>
                        <table id="summary-table">
                            <thead>
                                <tr>
                                    <th>اليوم</th>
                                    <th>عدد العمليات</th>
                                    <th>إجمالي المبيعات</th>
                                    <th>أكثر منتج مبيعاً</th>
                                </tr>
                            </thead>
                            <tbody id="summary-table-body">
                            </tbody>
                        </table>
                    </div>
                `;
                
                // تعيين الشهر الحالي
                const now = new Date();
                const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                const summaryMonthInput = document.getElementById('summary-month');
                if (summaryMonthInput) summaryMonthInput.value = currentMonth;
                
                // إنشاء التقرير الشهري
                generateMonthlySummary();
            }
        }
        
        // إنشاء ملخص شهري
        function generateMonthlySummary() {
            const monthInput = document.getElementById('summary-month');
            const yearInput = document.getElementById('summary-year');
            
            if (!monthInput || !yearInput) return;
            
            let targetMonthYear;
            if (monthInput.value) {
                targetMonthYear = monthInput.value;
            } else {
                const now = new Date();
                targetMonthYear = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                monthInput.value = targetMonthYear;
            }
            
            // مبيعات الشهر
            const monthlySales = salesData.filter(s => s.date.substring(0, 7) === targetMonthYear);
            const salesTotal = monthlySales.reduce((sum, sale) => sum + sale.total, 0);
            document.getElementById('summary-sales').textContent = formatCurrency(salesTotal);
            
            // مشتريات الشهر
            const monthlyPurchases = purchasesData.filter(p => p.date.substring(0, 7) === targetMonthYear);
            const purchasesTotal = monthlyPurchases.reduce((sum, purchase) => sum + purchase.total, 0);
            document.getElementById('summary-purchases').textContent = formatCurrency(purchasesTotal);
            
            // مجمل الربح
            const grossProfit = salesTotal - purchasesTotal;
            document.getElementById('summary-gross').textContent = formatCurrency(grossProfit);
            
            // مصروفات الشهر
            const monthlyExpenses = expensesData.filter(e => e.date.substring(0, 7) === targetMonthYear);
            const expensesTotal = monthlyExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('summary-expenses').textContent = formatCurrency(expensesTotal);
            
            // صافي الربح
            const netProfit = grossProfit - expensesTotal;
            document.getElementById('summary-net').textContent = formatCurrency(netProfit);
            
            // تحديث جدول تفاصيل المبيعات الشهرية
            updateSummaryTable(monthlySales, targetMonthYear);
        }
        
        // تحديث جدول الملخص
        function updateSummaryTable(monthlySales, targetMonthYear) {
            const tableBody = document.getElementById('summary-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (monthlySales.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 30px; color: #666;">
                            <i class="fas fa-info-circle"></i> لا توجد بيانات مبيعات لهذا الشهر
                        </td>
                    </tr>
                `;
                return;
            }
            
            // تجميع المبيعات حسب اليوم
            const salesByDay = {};
            monthlySales.forEach(sale => {
                const day = sale.date;
                if (!salesByDay[day]) {
                    salesByDay[day] = {
                        transactions: 0,
                        totalSales: 0,
                        products: {}
                    };
                }
                salesByDay[day].transactions++;
                salesByDay[day].totalSales += sale.total;
                
                // حساب تكرار المنتجات
                if (!salesByDay[day].products[sale.productName]) {
                    salesByDay[day].products[sale.productName] = 0;
                }
                salesByDay[day].products[sale.productName] += sale.quantity;
            });
            
            // تحويل إلى مصفوفة وفرز حسب التاريخ
            const days = Object.keys(salesByDay).sort((a, b) => b.localeCompare(a));
            
            days.forEach(day => {
                const dayData = salesByDay[day];
                const formattedDay = formatDate(day);
                
                // العثور على أكثر منتج مبيعاً لهذا اليوم
                let topProduct = '-';
                let maxQuantity = 0;
                Object.entries(dayData.products).forEach(([product, quantity]) => {
                    if (quantity > maxQuantity) {
                        maxQuantity = quantity;
                        topProduct = product;
                    }
                });
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formattedDay}</td>
                    <td>${dayData.transactions}</td>
                    <td>${formatCurrency(dayData.totalSales)}</td>
                    <td>${topProduct} ${maxQuantity > 0 ? `(${maxQuantity})` : ''}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // طباعة الملخص
        function printSummary() {
            const printContent = document.getElementById('summary');
            if (!printContent) return;
            
            const originalContent = document.body.innerHTML;
            document.body.innerHTML = printContent.innerHTML;
            window.print();
            document.body.innerHTML = originalContent;
            
            // إعادة تحميل المحتوى
            openTab('summary');
        }
        
        // تحميل محتوى النسخ الاحتياطي
        function loadBackupContent() {
            const content = document.getElementById('backup');
            
            if (content.querySelector('.alert')) {
                content.innerHTML = `
                    <h2 class="section-title">
                        <i class="fas fa-database"></i> النسخ الاحتياطي واستعادة البيانات
                    </h2>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>مهم:</strong> يستخدم هذا النظام تخزين البيانات محلياً في متصفحك. لحفظ البيانات بشكل دائم، يرجى إنشاء نسخة احتياطية وتخزينها في مكان آمن.
                        </div>
                    </div>
                    
                    <div class="stats-cards">
                        <div class="stat-card">
                            <h3>عدد عمليات البيع</h3>
                            <div class="value" id="backup-sales-count">0</div>
                            <div class="subtext">عملية بيع مخزنة</div>
                        </div>
                        <div class="stat-card">
                            <h3>عدد عمليات الشراء</h3>
                            <div class="value" id="backup-purchases-count">0</div>
                            <div class="subtext">عملية شراء مخزنة</div>
                        </div>
                        <div class="stat-card">
                            <h3>عدد المنتجات</h3>
                            <div class="value" id="backup-products-count">0</div>
                            <div class="subtext">منتج مسجل في النظام</div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" class="btn btn-success" onclick="createBackup()">
                            <i class="fas fa-download"></i> إنشاء نسخة احتياطية
                        </button>
                        <button type="button" class="btn btn-warning" onclick="restoreBackup()">
                            <i class="fas fa-upload"></i> استعادة نسخة احتياطية
                        </button>
                        <button type="button" class="btn btn-danger" onclick="clearAllData()">
                            <i class="fas fa-trash"></i> حذف جميع البيانات
                        </button>
                    </div>
                    
                    <div class="stat-card" style="margin-top: 30px;">
                        <h3>استعادة البيانات من ملف</h3>
                        <p>يمكنك استعادة البيانات من نسخة احتياطية سابقة:</p>
                        <div class="form-group" style="margin-top: 15px;">
                            <label for="backup-file">اختر ملف النسخة الاحتياطية</label>
                            <input type="file" id="backup-file" class="form-control" accept=".json">
                        </div>
                        <button type="button" class="btn btn-primary" onclick="importBackupFile()" style="margin-top: 15px;">
                            <i class="fas fa-file-import"></i> استيراد البيانات من الملف
                        </button>
                    </div>
                    
                    <div class="stat-card" style="margin-top: 20px;">
                        <h3>حول النظام</h3>
                        <p>تم تطوير هذا النظام بلغة HTML/JavaScript وهو يعمل كلياً على جهازك دون الحاجة لاتصال بالإنترنت.</p>
                        <p>جميع البيانات يتم تخزينها في ذاكرة المتصفح المحلية (localStorage).</p>
                        <p><strong>لضمان عدم فقدان البيانات:</strong></p>
                        <ul style="margin-right: 20px; margin-top: 10px;">
                            <li>أنشئ نسخة احتياطية بانتظام</li>
                            <li>احفظ النسخ الاحتياطية في أكثر من مكان</li>
                            <li>استخدم نفس المتصفح للعمل على النظام</li>
                        </ul>
                    </div>
                `;
                
                updateBackupStats();
            }
        }
        
        // إنشاء نسخة احتياطية
        function createBackup() {
            const backupData = {
                sales: salesData,
                purchases: purchasesData,
                expenses: expensesData,
                products: productsData,
                categories: categories,
                timestamp: new Date().toISOString(),
                systemName: 'بقالة أبو مالك - نظام المحاسبة'
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `backup_baqala_${new Date().toISOString().slice(0, 10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('تم إنشاء نسخة احتياطية بنجاح', 'success');
        }
        
        // استيراد نسخة احتياطية
        function importBackupFile() {
            const fileInput = document.getElementById('backup-file');
            if (!fileInput.files.length) {
                showNotification('الرجاء اختيار ملف النسخة الاحتياطية', 'warning');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // التحقق من صحة البيانات
                    if (!backupData.sales || !backupData.purchases || !backupData.products) {
                        showNotification('ملف النسخة الاحتياطية غير صالح', 'danger');
                        return;
                    }
                    
                    if (confirm('هل أنت متأكد من استعادة النسخة الاحتياطية؟ سيتم استبدال جميع البيانات الحالية.')) {
                        salesData = backupData.sales || [];
                        purchasesData = backupData.purchases || [];
                        expensesData = backupData.expenses || [];
                        productsData = backupData.products || [];
                        categories = backupData.categories || ['مواد غذائية', 'بهارات', 'معلبات', 'مشروبات', 'منظفات', 'أخرى'];
                        
                        saveAllData();
                        loadAllData();
                        
                        showNotification('تم استعادة النسخة الاحتياطية بنجاح', 'success');
                        fileInput.value = '';
                    }
                } catch (error) {
                    showNotification('خطأ في قراءة ملف النسخة الاحتياطية', 'danger');
                    console.error(error);
                }
            };
            
            reader.readAsText(file);
        }
        
        // حذف جميع البيانات
        function clearAllData() {
            if (confirm('هل أنت متأكد من حذف جميع البيانات؟ هذه العملية لا يمكن التراجع عنها.')) {
                salesData = [];
                purchasesData = [];
                expensesData = [];
                productsData = [];
                categories = ['مواد غذائية', 'بهارات', 'معلبات', 'مشروبات', 'منظفات', 'أخرى'];
                
                localStorage.clear();
                
                updateSalesTable();
                updatePurchasesTable();
                updateExpensesTable();
                updateProductsTable();
                updateCategoriesSelect();
                updateCategoriesFilter('sales');
                updateCategoriesFilter('purchases');
                updateCategoriesDisplay();
                updateStats();
                updateBackupStats();
                
                showNotification('تم حذف جميع البيانات بنجاح', 'success');
            }
        }
        
        // تحميل محتوى الأمان
        function loadSecurityContent() {
            const content = document.getElementById('security');
            
            if (content.querySelector('.alert')) {
                content.innerHTML = `
                    <h2 class="section-title">
                        <i class="fas fa-lock"></i> إدارة الأمان وكلمة المرور
                    </h2>
                    
                    <div class="password-manager">
                        <h3>تغيير كلمة المرور</h3>
                        <p>يمكنك تغيير كلمة المرور للنظام كاملاً (جميع الأقسام المحمية)</p>
                        <div class="password-form">
                            <input type="password" id="current-password" class="form-control" placeholder="كلمة المرور الحالية">
                            <input type="password" id="new-password" class="form-control" placeholder="كلمة المرور الجديدة">
                            <input type="password" id="confirm-password" class="form-control" placeholder="تأكيد كلمة المرور الجديدة">
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="changePassword()">
                                <i class="fas fa-key"></i> تغيير كلمة المرور
                            </button>
                        </div>
                    </div>
                    
                    <div class="password-manager">
                        <h3>إعدادات الأمان</h3>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="auto-logout" checked>
                                تسجيل الخروج التلقائي بعد 30 دقيقة من عدم النشاط
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="require-password-sales" checked>
                                طلب كلمة مرور لتعديل أو حذف عمليات البيع
                            </label>
                        </div>
                    </div>
                    
                    <div class="password-manager">
                        <h3>نظرة عامة على الأمان</h3>
                        <p><strong>حالة النظام:</strong> ${isLoggedIn ? 'مسجل دخول كامل' : 'قسم المبيعات فقط'}</p>
                        <p><strong>الأقسام المفتوحة:</strong> ${unlockedTabs.join('، ')}</p>
                        <p><strong>آخر نشاط:</strong> <span id="last-activity-display">الآن</span></p>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-danger" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                        </button>
                        <button class="btn btn-primary" onclick="openSecurityModal()">
                            <i class="fas fa-cog"></i> إعدادات متقدمة
                        </button>
                    </div>
                `;
                
                // تحديث وقت النشاط
                updateLastActivityDisplay();
                setInterval(updateLastActivityDisplay, 60000);
            }
        }
        
        // تحديث عرض وقت النشاط الأخير
        function updateLastActivityDisplay() {
            const display = document.getElementById('last-activity-display');
            if (display) {
                const now = Date.now();
                const diffMinutes = Math.floor((now - lastActivityTime) / 1000 / 60);
                
                if (diffMinutes === 0) {
                    display.textContent = 'الآن';
                } else if (diffMinutes === 1) {
                    display.textContent = 'قبل دقيقة واحدة';
                } else {
                    display.textContent = `قبل ${diffMinutes} دقيقة`;
                }
            }
        }
        
        // تحديث التاريخ والوقت الحالي
        function updateDateTime() {
            const now = new Date();
            const formattedDate = now.toLocaleDateString('ar-SA', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const formattedTime = now.toLocaleTimeString('ar-SA', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const display = document.getElementById('current-date-time');
            if (display) {
                display.innerHTML = `
                    ${formattedDate}<br>
                    <small>${formattedTime}</small>
                `;
            }
        }
        
        // إضافة عملية بيع (الوظيفة الرئيسية)
        function addSale(e) {
            e.preventDefault();
            
            const sale = {
                id: currentSaleId || Date.now(),
                date: document.getElementById('sale-date').value,
                time: document.getElementById('sale-time').value,
                productName: document.getElementById('product-name').value,
                category: document.getElementById('product-category').value,
                quantity: parseFloat(document.getElementById('sale-quantity').value),
                salePrice: parseInt(document.getElementById('sale-price').value),
                purchasePrice: parseInt(document.getElementById('purchase-price-input').value) || 0,
                paymentMethod: document.getElementById('payment-method').value,
                timestamp: new Date().getTime()
            };
            
            // حساب الإجمالي والربح
            sale.total = sale.quantity * sale.salePrice;
            sale.cost = sale.quantity * sale.purchasePrice;
            sale.profit = sale.total - sale.cost;
            
            if (currentSaleId) {
                // تعديل عملية بيع موجودة
                const index = salesData.findIndex(s => s.id === currentSaleId);
                if (index !== -1) {
                    // التحقق من كلمة المرور إذا كان مطلوباً
                    const requirePassword = document.getElementById('require-password-sales');
                    if (requirePassword && requirePassword.checked) {
                        const password = prompt('الرجاء إدخال كلمة المرور لتعديل عملية البيع:');
                        if (password !== systemPassword) {
                            showNotification('كلمة المرور غير صحيحة', 'danger');
                            return;
                        }
                    }
                    
                    salesData[index] = sale;
                    showNotification('تم تعديل عملية البيع بنجاح', 'success');
                }
                currentSaleId = null;
            } else {
                // إضافة عملية بيع جديدة
                salesData.push(sale);
                showNotification('تم إضافة عملية البيع بنجاح', 'success');
            }
            
            // تحديث الجدول والإحصائيات
            updateSalesTable();
            updateProfitDisplay();
            
            // مسح النموذج
            clearSalesForm();
            
            // حفظ البيانات
            saveAllData();
            
            // إظهار تنبيه الربح
            showProfitAlert(sale.profit, sale.productName);
        }
        
        // تعديل عملية بيع
        function editSale(id) {
            const sale = salesData.find(s => s.id === id);
            if (!sale) return;
            
            currentSaleId = id;
            document.getElementById('sale-date').value = sale.date;
            document.getElementById('sale-time').value = sale.time;
            document.getElementById('product-name').value = sale.productName;
            document.getElementById('product-category').value = sale.category;
            document.getElementById('sale-quantity').value = sale.quantity;
            document.getElementById('sale-price').value = sale.salePrice;
            document.getElementById('purchase-price-input').value = sale.purchasePrice;
            document.getElementById('payment-method').value = sale.paymentMethod;
            
            showNotification('تم تحميل عملية البيع للتعديل', 'info');
        }
        
        // حذف عملية بيع
        function deleteSale(id) {
            // التحقق من كلمة المرور إذا كان مطلوباً
            const requirePassword = document.getElementById('require-password-sales');
            if (requirePassword && requirePassword.checked) {
                const password = prompt('الرجاء إدخال كلمة المرور لحذف عملية البيع:');
                if (password !== systemPassword) {
                    showNotification('كلمة المرور غير صحيحة', 'danger');
                    return;
                }
            }
            
            if (confirm('هل أنت متأكد من حذف عملية البيع هذه؟')) {
                const index = salesData.findIndex(s => s.id === id);
                if (index !== -1) {
                    salesData.splice(index, 1);
                    updateSalesTable();
                    saveAllData();
                    showNotification('تم حذف عملية البيع بنجاح', 'success');
                }
            }
        }
        
        // معالجة إدخال اسم المنتج
        function handleProductInput(type = 'sales') {
            const productName = type === 'sales' 
                ? document.getElementById('product-name').value 
                : document.getElementById('purchase-product').value;
            
            if (!productName.trim()) return;
            
            // البحث عن المنتج في قاعدة البيانات
            const product = productsData.find(p => p.name === productName);
            if (product) {
                if (type === 'sales') {
                    // تعبئة السعر تلقائياً للمبيعات
                    document.getElementById('sale-price').value = product.salePrice;
                    document.getElementById('purchase-price-input').value = product.purchasePrice || 0;
                    document.getElementById('product-category').value = product.category;
                } else {
                    // تعبئة السعر تلقائياً للمشتريات
                    document.getElementById('purchase-price').value = product.purchasePrice || 0;
                }
            } else {
                // إذا لم يكن المنتج مسجلاً، السماح بإدخال السعر يدوياً
                if (type === 'sales') {
                    document.getElementById('sale-price').removeAttribute('readonly');
                    document.getElementById('purchase-price-input').removeAttribute('readonly');
                } else {
                    document.getElementById('purchase-price').removeAttribute('readonly');
                }
            }
            
            // عرض الاقتراحات
            showProductSuggestions(productName, type);
        }
        
        // مسح نموذج المبيعات
        function clearSalesForm() {
            const form = document.getElementById('sales-form');
            if (form) {
                form.reset();
                const now = new Date();
                const saleDateInput = document.getElementById('sale-date');
                const saleTimeInput = document.getElementById('sale-time');
                
                if (saleDateInput) saleDateInput.value = now.toISOString().split('T')[0];
                if (saleTimeInput) saleTimeInput.value = now.toTimeString().substring(0, 5);
                
                currentSaleId = null;
                const suggestions = document.getElementById('product-suggestions');
                if (suggestions) suggestions.style.display = 'none';
                
                // إعادة ضبط الحقول للقراءة فقط
                document.getElementById('sale-price').setAttribute('readonly', true);
                document.getElementById('purchase-price-input').setAttribute('readonly', true);
            }
        }
        
        // عرض اقتراحات المنتجات
        function showProductSuggestions(query, type) {
            const suggestionsDiv = type === 'sales' 
                ? document.getElementById('product-suggestions')
                : document.getElementById('purchase-product-suggestions');
            
            if (!suggestionsDiv) return;
            
            if (!query.trim()) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            const filteredProducts = productsData.filter(product =>
                product.name.toLowerCase().includes(query.toLowerCase()) ||
                (product.code && product.code.toLowerCase().includes(query.toLowerCase()))
            ).slice(0, 5); // عرض أول 5 نتائج فقط
            
            if (filteredProducts.length === 0) {
                suggestionsDiv.innerHTML = '<div class="product-item">لا توجد منتجات تطابق البحث</div>';
                suggestionsDiv.style.display = 'block';
                return;
            }
            
            suggestionsDiv.innerHTML = filteredProducts.map(product => `
                <div class="product-item" onclick="selectProduct('${product.name}', ${product.salePrice}, ${product.purchasePrice || 0}, '${product.category}', '${type}')">
                    <div class="product-name">${product.name}</div>
                    <div class="product-details">
                        <span>${product.category}</span>
                        <span>${formatCurrency(product.salePrice)}</span>
                    </div>
                </div>
            `).join('');
            
            suggestionsDiv.style.display = 'block';
        }
        
        // اختيار منتج من القائمة
        function selectProduct(productName, salePrice, purchasePrice, category, type) {
            if (type === 'sales') {
                document.getElementById('product-name').value = productName;
                document.getElementById('sale-price').value = salePrice;
                document.getElementById('purchase-price-input').value = purchasePrice;
                document.getElementById('product-category').value = category;
                document.getElementById('sale-price').setAttribute('readonly', true);
                document.getElementById('purchase-price-input').setAttribute('readonly', true);
                const suggestions = document.getElementById('product-suggestions');
                if (suggestions) suggestions.style.display = 'none';
                const quantityInput = document.getElementById('sale-quantity');
                if (quantityInput) quantityInput.focus();
            } else {
                document.getElementById('purchase-product').value = productName;
                document.getElementById('purchase-price').value = purchasePrice || '';
                const suggestions = document.getElementById('purchase-product-suggestions');
                if (suggestions) suggestions.style.display = 'none';
                const quantityInput = document.getElementById('purchase-quantity');
                if (quantityInput) quantityInput.focus();
            }
        }
        
        // تحديث جدول المبيعات
        function updateSalesTable(filteredData = null) {
            const data = filteredData || salesData;
            const tableBody = document.getElementById('sales-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 30px; color: #666;">
                            <i class="fas fa-info-circle"></i> لا توجد بيانات مبيعات مسجلة بعد
                        </td>
                    </tr>
                `;
                return;
            }
            
            // ترتيب البيانات من الأحدث إلى الأقدم
            const sortedData = [...data].sort((a, b) => b.timestamp - a.timestamp);
            
            sortedData.forEach(sale => {
                const profitClass = sale.profit >= 0 ? 'profit-positive' : 'profit-negative';
                const profitText = sale.profit >= 0 ? `+${formatCurrency(sale.profit)}` : formatCurrency(sale.profit);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(sale.date)}<br><small>${sale.time}</small></td>
                    <td>${sale.productName}</td>
                    <td>${sale.category}</td>
                    <td>${sale.quantity}</td>
                    <td>${formatCurrency(sale.salePrice)}</td>
                    <td>${formatCurrency(sale.purchasePrice)}</td>
                    <td><span class="profit-indicator ${profitClass}">${profitText}</span></td>
                    <td>${sale.paymentMethod}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-warning" onclick="editSale(${sale.id})" style="padding: 5px 8px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger" onclick="deleteSale(${sale.id})" style="padding: 5px 8px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // تحديث الإحصائيات
            updateSalesStats(data);
        }
        
        // تحديث جدول المشتريات
        function updatePurchasesTable(filteredData = null) {
            const data = filteredData || purchasesData;
            const tableBody = document.getElementById('purchases-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 30px; color: #666;">
                            <i class="fas fa-info-circle"></i> لا توجد بيانات مشتريات مسجلة بعد
                        </td>
                    </tr>
                `;
                return;
            }
            
            // ترتيب البيانات من الأحدث إلى الأقدم
            const sortedData = [...data].sort((a, b) => b.timestamp - a.timestamp);
            
            sortedData.forEach(purchase => {
                const currentStock = calculateCurrentStock(purchase.productName);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(purchase.date)}<br><small>${purchase.time}</small></td>
                    <td>${purchase.productName}</td>
                    <td>${purchase.supplier}</td>
                    <td>${purchase.quantity}</td>
                    <td>${formatCurrency(purchase.price)}</td>
                    <td>${formatCurrency(purchase.total)}</td>
                    <td>${currentStock}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-warning" onclick="editPurchase(${purchase.id})" style="padding: 5px 8px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger" onclick="deletePurchase(${purchase.id})" style="padding: 5px 8px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // تحديث جدول المصروفات
        function updateExpensesTable(filteredData = null) {
            const data = filteredData || expensesData;
            const tableBody = document.getElementById('expenses-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 30px; color: #666;">
                            <i class="fas fa-info-circle"></i> لا توجد بيانات مصروفات مسجلة بعد
                        </td>
                    </tr>
                `;
                return;
            }
            
            // ترتيب البيانات من الأحدث إلى الأقدم
            const sortedData = [...data].sort((a, b) => b.timestamp - a.timestamp);
            
            sortedData.forEach(expense => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(expense.date)}<br><small>${expense.time}</small></td>
                    <td>${expense.type}</td>
                    <td>${formatCurrency(expense.amount)}</td>
                    <td>${expense.notes || '-'}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-warning" onclick="editExpense(${expense.id})" style="padding: 5px 8px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger" onclick="deleteExpense(${expense.id})" style="padding: 5px 8px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // تحديث جدول المنتجات
        function updateProductsTable(filteredData = null) {
            const data = filteredData || productsData;
            const tableBody = document.getElementById('products-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 30px; color: #666;">
                            <i class="fas fa-info-circle"></i> لا توجد منتجات مسجلة بعد. أضف منتجاتك أولاً.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // ترتيب البيانات أبجدياً
            const sortedData = [...data].sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            
            sortedData.forEach(product => {
                const currentStock = calculateCurrentStock(product.name);
                const minStock = product.minStock || 0;
                const stockClass = currentStock <= minStock ? 'style="color: var(--danger); font-weight: bold;"' : '';
                const profit = product.salePrice - product.purchasePrice;
                const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';
                const profitText = profit >= 0 ? `+${formatCurrency(profit)}` : formatCurrency(profit);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>${product.code || '-'}</td>
                    <td>${product.purchasePrice ? formatCurrency(product.purchasePrice) : '-'}</td>
                    <td>${formatCurrency(product.salePrice)}</td>
                    <td><span class="profit-indicator ${profitClass}">${profitText}</span></td>
                    <td>${product.unit}</td>
                    <td ${stockClass}>${currentStock} / ${minStock}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-info" onclick="useProduct('${product.name}', ${product.salePrice}, ${product.purchasePrice || 0})" style="padding: 5px 8px;" title="استخدم في عملية بيع">
                                <i class="fas fa-shopping-cart"></i>
                            </button>
                            <button class="btn btn-warning" onclick="editProduct(${product.id})" style="padding: 5px 8px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger" onclick="deleteProduct(${product.id})" style="padding: 5px 8px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // استخدام منتج في عملية بيع
        function useProduct(productName, salePrice, purchasePrice) {
            openTab('sales');
            document.getElementById('product-name').value = productName;
            document.getElementById('sale-price').value = salePrice;
            document.getElementById('purchase-price-input').value = purchasePrice || '';
            
            // البحث عن الصنف التابع للمنتج
            const product = productsData.find(p => p.name === productName);
            if (product) {
                document.getElementById('product-category').value = product.category;
            }
            
            const quantityInput = document.getElementById('sale-quantity');
            if (quantityInput) quantityInput.focus();
            showNotification(`تم تحضير المنتج "${productName}" للبيع`, 'info');
        }
        
        // تحديث عرض الربح
        function updateProfitDisplay() {
            // حساب الربح الإجمالي
            currentProfit = salesData.reduce((sum, sale) => sum + sale.profit, 0);
            todayProfit = salesData
                .filter(s => s.date === new Date().toISOString().split('T')[0])
                .reduce((sum, sale) => sum + sale.profit, 0);
            
            const profitDisplay = document.getElementById('current-profit');
            const profitContainer = document.getElementById('live-profit-display');
            
            if (profitDisplay) {
                profitDisplay.textContent = formatCurrency(currentProfit);
                
                // تغيير اللون حسب الربح
                if (currentProfit >= 0) {
                    if (profitContainer) profitContainer.classList.remove('loss');
                } else {
                    if (profitContainer) profitContainer.classList.add('loss');
                }
            }
            
            // تحديث ربح اليوم
            const todayProfitElement = document.getElementById('today-profit');
            if (todayProfitElement) {
                todayProfitElement.textContent = formatCurrency(todayProfit);
            }
        }
        
        // إظهار تنبيه الربح
        function showProfitAlert(profit, productName) {
            if (profit > 0) {
                showNotification(`ربح ${formatCurrency(profit)} من بيع ${productName}`, 'success');
            } else if (profit < 0) {
                showNotification(`خسارة ${formatCurrency(Math.abs(profit))} من بيع ${productName}`, 'danger');
            } else {
                showNotification(`لا يوجد ربح أو خسارة من بيع ${productName}`, 'info');
            }
        }
        
        // عرض تفاصيل الربح
        function toggleProfitDetails() {
            const modal = document.getElementById('profit-details-modal');
            
            // حساب التفاصيل
            const totalSales = salesData.reduce((sum, sale) => sum + sale.total, 0);
            const totalCost = salesData.reduce((sum, sale) => sum + sale.cost, 0);
            const grossProfit = totalSales - totalCost;
            
            // تحديث القيم
            document.getElementById('profit-total-sales').textContent = formatCurrency(totalSales);
            document.getElementById('profit-cost').textContent = formatCurrency(totalCost);
            document.getElementById('profit-gross').textContent = formatCurrency(grossProfit);
            
            // تحديث أحدث العمليات
            const recentTable = document.getElementById('profit-recent-table');
            const recentSales = [...salesData]
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 10);
            
            recentTable.innerHTML = recentSales.map(sale => {
                const profitClass = sale.profit >= 0 ? 'profit-positive' : 'profit-negative';
                const profitText = sale.profit >= 0 ? `+${formatCurrency(sale.profit)}` : formatCurrency(sale.profit);
                
                return `
                    <tr>
                        <td>${sale.time}</td>
                        <td>${sale.productName}</td>
                        <td>${sale.quantity}</td>
                        <td><span class="profit-indicator ${profitClass}">${profitText}</span></td>
                    </tr>
                `;
            }).join('');
            
            modal.style.display = 'flex';
        }
        
        // البحث في المبيعات
        function searchSales() {
            const searchInput = document.getElementById('search-sales');
            if (!searchInput) return;
            
            const query = searchInput.value.toLowerCase();
            if (!query.trim()) {
                updateSalesTable();
                return;
            }
            
            const filtered = salesData.filter(sale => 
                sale.productName.toLowerCase().includes(query) ||
                sale.date.includes(query) ||
                sale.category.toLowerCase().includes(query) ||
                sale.paymentMethod.toLowerCase().includes(query) ||
                sale.time.includes(query)
            );
            
            updateSalesTable(filtered);
        }
        
        // البحث في المشتريات
        function searchPurchases() {
            const searchInput = document.getElementById('search-purchases');
            if (!searchInput) return;
            
            const query = searchInput.value.toLowerCase();
            if (!query.trim()) {
                updatePurchasesTable();
                return;
            }
            
            const filtered = purchasesData.filter(purchase => 
                purchase.productName.toLowerCase().includes(query) ||
                purchase.date.includes(query) ||
                purchase.supplier.toLowerCase().includes(query) ||
                purchase.time.includes(query)
            );
            
            updatePurchasesTable(filtered);
        }
        
        // البحث في المصروفات
        function searchExpenses() {
            const searchInput = document.getElementById('search-expenses');
            if (!searchInput) return;
            
            const query = searchInput.value.toLowerCase();
            if (!query.trim()) {
                updateExpensesTable();
                return;
            }
            
            const filtered = expensesData.filter(expense => 
                expense.type.toLowerCase().includes(query) ||
                expense.date.includes(query) ||
                (expense.notes && expense.notes.toLowerCase().includes(query)) ||
                expense.time.includes(query)
            );
            
            updateExpensesTable(filtered);
        }
        
        // البحث في المنتجات
        function searchProducts() {
            const searchInput = document.getElementById('search-products');
            if (!searchInput) return;
            
            const query = searchInput.value.toLowerCase();
            if (!query.trim()) {
                updateProductsTable();
                return;
            }
            
            const filtered = productsData.filter(product => 
                product.name.toLowerCase().includes(query) ||
                product.category.toLowerCase().includes(query) ||
                (product.code && product.code.toLowerCase().includes(query)) ||
                (product.description && product.description.toLowerCase().includes(query))
            );
            
            updateProductsTable(filtered);
        }
        
        // تحديث إحصائيات المبيعات
        function updateSalesStats(data = null) {
            const sales = data || salesData;
            const today = new Date().toISOString().split('T')[0];
            
            // مبيعات اليوم
            const todaySales = sales.filter(s => s.date === today);
            const todayTotal = todaySales.reduce((sum, sale) => sum + sale.total, 0);
            const todayProfit = todaySales.reduce((sum, sale) => sum + sale.profit, 0);
            
            const todaySalesElement = document.getElementById('today-sales');
            const todayProfitElement = document.getElementById('today-profit');
            const todayTransactionsElement = document.getElementById('today-transactions');
            
            if (todaySalesElement) todaySalesElement.textContent = formatCurrency(todayTotal);
            if (todayProfitElement) todayProfitElement.textContent = formatCurrency(todayProfit);
            if (todayTransactionsElement) todayTransactionsElement.textContent = todaySales.length;
        }
        
        // تحديث إحصائيات المشتريات
        function updatePurchasesStats(data = null) {
            const purchases = data || purchasesData;
            const currentMonth = new Date().toISOString().substring(0, 7);
            
            // مشتريات هذا الشهر
            const monthlyPurchases = purchases.filter(p => p.date.substring(0, 7) === currentMonth);
            const monthlyTotal = monthlyPurchases.reduce((sum, purchase) => sum + purchase.total, 0);
            
            const totalPurchasesElement = document.getElementById('total-purchases');
            const totalProductsElement = document.getElementById('total-products');
            const lowStockElement = document.getElementById('low-stock');
            
            if (totalPurchasesElement) totalPurchasesElement.textContent = formatCurrency(monthlyTotal);
            
            // عدد المنتجات في المخزون
            const uniqueProducts = new Set(purchases.map(p => p.productName));
            if (totalProductsElement) totalProductsElement.textContent = uniqueProducts.size;
            
            // المنتجات المنخفضة في المخزون
            let lowStockCount = 0;
            uniqueProducts.forEach(product => {
                const stock = calculateCurrentStock(product);
                const productData = productsData.find(p => p.name === product);
                const minStock = productData ? (productData.minStock || 5) : 5;
                
                if (stock <= minStock) {
                    lowStockCount++;
                }
            });
            
            if (lowStockElement) lowStockElement.textContent = lowStockCount;
        }
        
        // تحديث إحصائيات المصروفات
        function updateExpensesStats(data = null) {
            const expenses = data || expensesData;
            const currentMonth = new Date().toISOString().substring(0, 7);
            
            // مصروفات هذا الشهر
            const monthlyExpenses = expenses.filter(e => e.date.substring(0, 7) === currentMonth);
            const monthlyTotal = monthlyExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            const monthlyExpensesElement = document.getElementById('monthly-expenses');
            const highestExpenseElement = document.getElementById('highest-expense');
            const avgExpenseElement = document.getElementById('avg-expense');
            
            if (monthlyExpensesElement) monthlyExpensesElement.textContent = formatCurrency(monthlyTotal);
            
            // أعلى مصروف
            if (monthlyExpenses.length > 0) {
                const highest = Math.max(...monthlyExpenses.map(e => e.amount));
                if (highestExpenseElement) highestExpenseElement.textContent = formatCurrency(highest);
                
                // متوسط المصروفات اليومية
                const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
                const dailyAvg = monthlyTotal / daysInMonth;
                if (avgExpenseElement) avgExpenseElement.textContent = formatCurrency(Math.round(dailyAvg));
            } else {
                if (highestExpenseElement) highestExpenseElement.textContent = formatCurrency(0);
                if (avgExpenseElement) avgExpenseElement.textContent = formatCurrency(0);
            }
        }
        
        // تحديث إحصائيات المنتجات
        function updateProductsStats() {
            const categoriesElement = document.getElementById('total-categories');
            const productsElement = document.getElementById('total-products-items');
            const highestProfitElement = document.getElementById('highest-profit');
            
            if (categoriesElement) categoriesElement.textContent = categories.length;
            if (productsElement) productsElement.textContent = productsData.length;
            
            // أعلى ربح للمنتج
            if (productsData.length > 0 && highestProfitElement) {
                const highestProfit = Math.max(...productsData.map(p => p.salePrice - p.purchasePrice));
                highestProfitElement.textContent = formatCurrency(highestProfit);
            } else if (highestProfitElement) {
                highestProfitElement.textContent = formatCurrency(0);
            }
        }
        
        // تحديث جميع الإحصائيات
        function updateStats() {
            updateSalesStats();
            updatePurchasesStats();
            updateExpensesStats();
            updateProductsStats();
            updateProfitDisplay();
        }
        
        // تغيير كلمة المرور
        function changePassword() {
            const current = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;
            
            if (current !== systemPassword) {
                showNotification('كلمة المرور الحالية غير صحيحة', 'danger');
                document.getElementById('current-password').value = ''; // مسح كلمة المرور
                return;
            }
            
            if (newPass.length < 4) {
                showNotification('كلمة المرور الجديدة يجب أن تكون 4 أحرف على الأقل', 'warning');
                return;
            }
            
            if (newPass !== confirmPass) {
                showNotification('كلمات المرور الجديدة غير متطابقة', 'danger');
                document.getElementById('new-password').value = ''; // مسح كلمة المرور
                document.getElementById('confirm-password').value = ''; // مسح كلمة المرور
                return;
            }
            
            systemPassword = newPass;
            saveSecuritySettings();
            showNotification('تم تغيير كلمة المرور بنجاح', 'success');
            
            // مسح الحقول
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
        }
        
        // حفظ إعدادات الأمان
        function saveSecuritySettings() {
            try {
                const settings = {
                    password: systemPassword,
                    autoLogout: document.getElementById('auto-logout')?.checked || true,
                    requirePasswordSales: document.getElementById('require-password-sales')?.checked || true
                };
                localStorage.setItem('baqalaSecurity', JSON.stringify(settings));
            } catch (error) {
                console.error('خطأ في حفظ إعدادات الأمان:', error);
            }
        }
        
        // تحميل إعدادات الأمان
        function loadSecuritySettings() {
            try {
                const saved = localStorage.getItem('baqalaSecurity');
                if (saved) {
                    const settings = JSON.parse(saved);
                    systemPassword = settings.password || "123456";
                }
            } catch (error) {
                console.error('خطأ في تحميل إعدادات الأمان:', error);
            }
        }
        
        // إغلاق المودال
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // فتح مودال الأمان
        function openSecurityModal() {
            document.getElementById('security-modal').style.display = 'flex';
        }
        
        // حفظ جميع البيانات
        function saveAllData() {
            try {
                localStorage.setItem('baqalaSales', JSON.stringify(salesData));
                localStorage.setItem('baqalaPurchases', JSON.stringify(purchasesData));
                localStorage.setItem('baqalaExpenses', JSON.stringify(expensesData));
                localStorage.setItem('baqalaProducts', JSON.stringify(productsData));
                localStorage.setItem('baqalaCategories', JSON.stringify(categories));
                localStorage.setItem('baqalaLastSave', new Date().toISOString());
                
                // حفظ إعدادات الأمان
                saveSecuritySettings();
                
                // تحديث الإحصائيات
                updateStats();
                updateBackupStats();
                
                showNotification('تم حفظ البيانات بنجاح', 'success');
            } catch (error) {
                showNotification('خطأ في حفظ البيانات', 'danger');
                console.error(error);
            }
        }
        
        // تحميل جميع البيانات
        function loadAllData() {
            try {
                const savedSales = localStorage.getItem('baqalaSales');
                const savedPurchases = localStorage.getItem('baqalaPurchases');
                const savedExpenses = localStorage.getItem('baqalaExpenses');
                const savedProducts = localStorage.getItem('baqalaProducts');
                const savedCategories = localStorage.getItem('baqalaCategories');
                
                if (savedSales) salesData = JSON.parse(savedSales);
                if (savedPurchases) purchasesData = JSON.parse(savedPurchases);
                if (savedExpenses) expensesData = JSON.parse(savedExpenses);
                if (savedProducts) productsData = JSON.parse(savedProducts);
                if (savedCategories) categories = JSON.parse(savedCategories);
                
                updateSalesTable();
                updatePurchasesTable();
                updateExpensesTable();
                updateProductsTable();
                updateCategoriesSelect();
                updateCategoriesFilter('sales');
                updateCategoriesFilter('purchases');
                updateCategoriesDisplay();
                updateStats();
                updateBackupStats();
                
                const lastSave = localStorage.getItem('baqalaLastSave');
                if (lastSave) {
                    const lastSaveDate = new Date(lastSave).toLocaleString('ar-SA');
                    showNotification(`تم تحميل البيانات آخر تحديث: ${lastSaveDate}`, 'info');
                } else {
                    showNotification('تم تحميل البيانات بنجاح', 'success');
                }
            } catch (error) {
                showNotification('خطأ في تحميل البيانات', 'danger');
                console.error(error);
            }
        }
        
        // وظائف مساعدة
        function formatDate(dateStr) {
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('ar-SA');
            } catch {
                return dateStr;
            }
        }
        
        function formatCurrency(amount) {
            return amount.toLocaleString('ar-SA') + ' ريال';
        }
        
        function calculateCurrentStock(productName) {
            // حساب إجمالي المشتريات لهذا المنتج
            const totalPurchased = purchasesData
                .filter(p => p.productName === productName)
                .reduce((sum, p) => sum + p.quantity, 0);
            
            // حساب إجمالي المبيعات لهذا المنتج
            const totalSold = salesData
                .filter(s => s.productName === productName)
                .reduce((sum, s) => sum + s.quantity, 0);
            
            return totalPurchased - totalSold;
        }
        
        // إظهار الإشعارات
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = '';
            notification.classList.add(type);
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // الوظائف المتبقية
        function showHelp() {
            document.getElementById('help-modal').style.display = 'flex';
        }
        
        function updateBackupStats() {
            const salesCountElement = document.getElementById('backup-sales-count');
            const purchasesCountElement = document.getElementById('backup-purchases-count');
            const productsCountElement = document.getElementById('backup-products-count');
            
            if (salesCountElement) salesCountElement.textContent = salesData.length;
            if (purchasesCountElement) purchasesCountElement.textContent = purchasesData.length;
            if (productsCountElement) productsCountElement.textContent = productsData.length;
        }
        
        // وظائف إضافية
        function showProductSelection(type) {
            const suggestionsDiv = type === 'sales' 
                ? document.getElementById('product-suggestions')
                : document.getElementById('purchase-product-suggestions');
            
            const query = type === 'sales' 
                ? document.getElementById('product-name').value
                : document.getElementById('purchase-product').value;
            
            showProductSuggestions(query, type);
            
            if (suggestionsDiv && suggestionsDiv.style.display === 'none') {
                showProductSuggestions('', type);
            }
        }
        
        function showQuickProducts(type) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            
            let productsHtml = '';
            if (productsData.length === 0) {
                productsHtml = '<div class="alert alert-info">لا توجد منتجات مسجلة بعد</div>';
            } else {
                productsHtml = '<div class="quick-categories" style="margin-bottom: 20px;">';
                categories.forEach(category => {
                    const categoryProducts = productsData.filter(p => p.category === category);
                    if (categoryProducts.length > 0) {
                        productsHtml += `<div class="category-chip">${category}</div>`;
                    }
                });
                productsHtml += '</div>';
                
                productsHtml += '<div class="products-grid">';
                productsData.forEach(product => {
                    const currentStock = calculateCurrentStock(product.name);
                    productsHtml += `
                        <div class="product-card" onclick="selectProduct('${product.name}', ${product.salePrice}, ${product.purchasePrice || 0}, '${product.category}', '${type}')">
                            <div class="product-card-header">
                                <h4>${product.name}</h4>
                                <span class="product-price">${formatCurrency(product.salePrice)}</span>
                            </div>
                            <div class="product-card-body">
                                <p><strong>الصنف:</strong> ${product.category}</p>
                                <p><strong>سعر الشراء:</strong> ${product.purchasePrice ? formatCurrency(product.purchasePrice) : '-'}</p>
                                <p><strong>الربح:</strong> ${formatCurrency(product.salePrice - (product.purchasePrice || 0))}</p>
                                <p><strong>المخزون:</strong> ${currentStock}</p>
                                <p><strong>الوحدة:</strong> ${product.unit}</p>
                            </div>
                        </div>
                    `;
                });
                productsHtml += '</div>';
            }
            
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 class="section-title">
                        <i class="fas fa-list"></i> المنتجات المتوفرة
                    </h2>
                    ${productsHtml}
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i> إغلاق
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function generateInventoryReport() {
            let report = '<h2>تقرير المخزون</h2><table class="table-container"><thead><tr><th>اسم المنتج</th><th>الصنف</th><th>المخزون الحالي</th><th>الحد الأدنى</th><th>الحالة</th></tr></thead><tbody>';
            
            const uniqueProducts = new Set([...purchasesData.map(p => p.productName), ...productsData.map(p => p.name)]);
            
            let lowStockCount = 0;
            let outOfStockCount = 0;
            
            uniqueProducts.forEach(productName => {
                const stock = calculateCurrentStock(productName);
                const product = productsData.find(p => p.name === productName);
                const minStock = product ? (product.minStock || 5) : 5;
                let status = 'جيد';
                let statusClass = 'profit-positive';
                
                if (stock <= 0) {
                    status = 'نفذ من المخزون';
                    statusClass = 'profit-negative';
                    outOfStockCount++;
                } else if (stock <= minStock) {
                    status = 'منخفض';
                    statusClass = 'profit-negative';
                    lowStockCount++;
                }
                
                report += `<tr>
                    <td>${productName}</td>
                    <td>${product ? product.category : '-'}</td>
                    <td>${stock}</td>
                    <td>${minStock}</td>
                    <td><span class="profit-indicator ${statusClass}">${status}</span></td>
                </tr>`;
            });
            
            report += `</tbody></table><div class="stats-cards">
                <div class="stat-card">
                    <h3>إجمالي المنتجات</h3>
                    <div class="value">${uniqueProducts.size}</div>
                </div>
                <div class="stat-card">
                    <h3>منخفضة المخزون</h3>
                    <div class="value">${lowStockCount}</div>
                </div>
                <div class="stat-card">
                    <h3>نفذت من المخزون</h3>
                    <div class="value">${outOfStockCount}</div>
                </div>
            </div>`;
            
            const newWindow = window.open();
            newWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>تقرير المخزون - بقالة أبو مالك</title>
                    <style>
                        body { font-family: 'Tajawal', sans-serif; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
                        th { background-color: #f5f5f5; }
                        .profit-positive { color: green; }
                        .profit-negative { color: red; }
                        .stats-cards { display: flex; justify-content: space-around; margin: 20px 0; }
                        .stat-card { text-align: center; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                        .value { font-size: 24px; font-weight: bold; }
                    </style>
                </head>
                <body>
                    ${report}
                    <script>
                        window.onload = function() { window.print(); }
                    </script>
                </body>
                </html>
            `);
        }
        
        function printSalesReport() {
            const printContent = document.getElementById('sales');
            if (!printContent) return;
            
            const originalContent = document.body.innerHTML;
            document.body.innerHTML = printContent.innerHTML;
            window.print();
            document.body.innerHTML = originalContent;
            
            // إعادة تحميل المحتوى
            openTab('sales');
        }
        
        function exportProducts() {
            const dataStr = JSON.stringify(productsData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `products_baqala_${new Date().toISOString().slice(0, 10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('تم تصدير المنتجات بنجاح', 'success');
        }
        
        // إضافة بعض البيانات الافتراضية للاختبار
        function addSampleData() {
            if (productsData.length === 0) {
                productsData = [
                    {
                        id: 1,
                        name: "أرز بسمتي",
                        category: "مواد غذائية",
                        code: "RICE-001",
                        purchasePrice: 2500,
                        salePrice: 3000,
                        unit: "كيلو",
                        minStock: 10,
                        description: "أرز بسمتي هندي عالي الجودة"
                    },
                    {
                        id: 2,
                        name: "سكر",
                        category: "مواد غذائية",
                        code: "SUGAR-001",
                        purchasePrice: 1500,
                        salePrice: 2000,
                        unit: "كيلو",
                        minStock: 15,
                        description: "سكر أبيض ناعم"
                    },
                    {
                        id: 3,
                        name: "كمون",
                        category: "بهارات",
                        code: "SPICE-001",
                        purchasePrice: 800,
                        salePrice: 1200,
                        unit: "جرام",
                        minStock: 20,
                        description: "كمون مطحون"
                    }
                ];
                
                saveAllData();
                loadAllData();
                showNotification('تم إضافة بيانات اختبارية', 'info');
            }
        }
        
        // استدعاء إضافة بيانات الاختبار عند الحاجة
        // addSampleData();
        
    </script>
</body>
</html>